<!DOCTYPE html>
<html lang="en" class="h-full">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>AutonomiQ Audit AI — Internal Audit Suite</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: {
            sans: ['Inter', 'system-ui', 'sans-serif']
          },
          colors: {
            primary: {
              50: '#eef4ff',
              100: '#e0eaff',
              200: '#c7d7ff',
              300: '#a4bbff',
              400: '#7b96ff',
              500: '#4f73f5',
              600: '#2157d5', // Automotive blue
              700: '#1541a6',
              800: '#0f327f',
              900: '#0a2761',
            },
            steel: {
              50: '#f6f7f9',
              100: '#eceef2',
              200: '#d9dde6',
              300: '#b9c0cf',
              400: '#96a0b2',
              500: '#738198',
              600: '#59667c',
              700: '#485364',
              800: '#36404b',
              900: '#242b34',
            },
            brand: {
              50: '#eef2ff',
              100: '#e0e7ff',
              200: '#c7d2fe',
              300: '#a5b4fc',
              400: '#818cf8',
              500: '#6366f1',
              600: '#4f46e5',
              700: '#4338ca',
              800: '#3730a3',
              900: '#312e81',
            },
            accent: {
              50: '#ecfeff',
              100: '#cffafe',
              200: '#a5f3fc',
              300: '#67e8f9',
              400: '#22d3ee',
              500: '#06b6d4',
              600: '#0891b2',
              700: '#0e7490',
              800: '#155e75',
              900: '#164e63',
            },
            compliant: '#10B981', // green
            warning: '#F59E0B', // yellow
            critical: '#EF4444', // red
            esg: '#22C55E',
          },
          boxShadow: {
            soft: '0 8px 24px rgba(20, 40, 80, 0.08)',
            card: '0 10px 30px rgba(15, 23, 42, 0.08)',
            inset: 'inset 0 1px 0 rgba(255,255,255,0.1)',
          },
          borderRadius: {
            xl2: '1rem',
            xl3: '1.25rem',
          },
        }
      },
      darkMode: 'class'
    }
  </script>
  <style>
    html,
    body {
      height: 100%;
    }

    /* Decorative conic rings */
    .ring-conic {
      background: conic-gradient(var(--ring-color) calc(var(--pct, 0) * 1%), #e5e7eb 0);
    }

    .dark .ring-conic {
      background: conic-gradient(var(--ring-color) calc(var(--pct, 0) * 1%), #1f2937 0);
    }

    /* Nice scrollbars */
    * {
      scrollbar-width: thin;
      scrollbar-color: #9AA4B2 transparent;
    }

    *::-webkit-scrollbar {
      height: 8px;
      width: 10px;
    }

    *::-webkit-scrollbar-thumb {
      background: #9AA4B2;
      border-radius: 999px;
    }

    *::-webkit-scrollbar-track {
      background: transparent;
    }

    /* Heatmap hover */
    .heat-cell:hover {
      transform: translateY(-2px);
    }

    /* Floating chat open state */
    .chat-open {
      transform: translateY(0);
      opacity: 1;
      pointer-events: auto;
    }

    .chat-closed {
      transform: translateY(20px);
      opacity: 0;
      pointer-events: none;
    }

    /* Subtle gradient bg */
    .bg-grid {
      background:
        radial-gradient(1000px 400px at 10% -10%, rgba(33, 87, 213, 0.10), transparent 60%),
        radial-gradient(900px 400px at 110% 10%, rgba(115, 129, 152, 0.08), transparent 70%),
        linear-gradient(180deg, rgba(255, 255, 255, 0.65), rgba(255, 255, 255, 0.25));
    }

    .dark .bg-grid {
      background:
        radial-gradient(1000px 400px at 10% -10%, rgba(79, 115, 245, 0.18), transparent 60%),
        radial-gradient(900px 400px at 110% 10%, rgba(54, 64, 75, 0.35), transparent 70%),
        linear-gradient(180deg, rgba(15, 23, 42, 0.65), rgba(15, 23, 42, 0.25));
    }

    /* Card hover */
    .card-hover {
      transition: transform .25s ease, box-shadow .25s ease;
    }

    .card-hover:hover {
      transform: translateY(-3px);
      box-shadow: 0 16px 40px rgba(15, 23, 42, 0.12);
    }

    /* Badge glow */
    .glow-green {
      box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.15);
    }

    .glow-yellow {
      box-shadow: 0 0 0 3px rgba(245, 158, 11, 0.18);
    }

    .glow-red {
      box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.2);
    }
  </style>
</head>

<body class="bg-grid text-steel-900 dark:text-steel-100 dark:bg-steel-900/80">
  <div class="min-h-full flex">

    <aside class="hidden lg:flex lg:flex-col w-[300px] bg-white/80 backdrop-blur-md dark:bg-steel-800/70 border-r border-steel-100 dark:border-steel-700">
      <div class="flex items-center gap-3 p-5">
        <div class="h-10 w-10 rounded-full bg-primary-600 flex items-center justify-center text-white shadow-card">
          <svg viewBox="0 0 24 24" class="h-6 w-6">
            <path fill="currentColor" d="M12 2a10 10 0 1 0 .001 20.001A10 10 0 0 0 12 2Zm0 2a8 8 0 0 1 7.529 5.5H16.5a4.5 4.5 0 0 0-9 0H4.47A8 8 0 0 1 12 4Zm0 16a8 8 0 0 1-7.53-5.5H7.5a4.5 4.5 0 0 0 9 0h3a8 8 0 0 1-7.5 5.5Z" />
          </svg>
        </div>
        <div>
          <div class="text-lg font-extrabold leading-tight">AutonomiQ</div>
          <div class="text-xs uppercase tracking-widest text-steel-500">Audit AI Suite</div>
        </div>
      </div>

      <nav class="px-3">
        <ul id="navList" class="space-y-1">
          </ul>
      </nav>

      <div class="mt-auto p-4 space-y-3">
        <div class="p-3 rounded-xl2 bg-primary-50 dark:bg-steel-700/60 border border-primary-100 dark:border-steel-600">
          <div class="text-xs uppercase tracking-widest text-primary-700 dark:text-primary-300 mb-1">Environment</div>
          <div class="flex items-center gap-2 text-sm">
            <span class="size-2.5 rounded-full bg-green-500 glow-green"></span>
            Production
          </div>
        </div>
        <div class="text-[11px] text-steel-500">This is a demo UI. Some features simulate behavior locally.</div>
      </div>
    </aside>

    <div class="flex-1 flex flex-col">
      <header class="sticky top-0 z-30 backdrop-blur-md bg-white/70 dark:bg-steel-900/70 border-b border-steel-100 dark:border-steel-800">
        <div class="max-w-[1400px] mx-auto px-4">
          <div class="h-16 flex items-center justify-between">
            <button id="mobileMenuBtn" class="lg:hidden inline-flex items-center gap-2 px-3 py-2 rounded-lg border border-steel-200 dark:border-steel-700 text-steel-700 dark:text-steel-100 bg-white dark:bg-steel-800">
              <svg class="h-5 w-5" viewBox="0 0 24 24" fill="currentColor">
                <path d="M3 6h18M3 12h18M3 18h18" />
              </svg>
              Menu
            </button>
            <div class="flex items-center gap-3">
              <div class="hidden md:flex items-center gap-2 text-sm text-steel-600 dark:text-steel-300">
                <span id="pageIcon" class="inline-flex items-center justify-center size-7 rounded-md bg-primary-600 text-white shadow-soft"></span>
                <span id="pageTitle" class="text-base md:text-lg font-semibold">Dashboard</span>
              </div>
            </div>
            <div class="flex items-center gap-2">
              <div class="hidden md:flex items-center relative">
                <input id="globalSearch" type="search" placeholder="Search audits, agents, risks..." class="w-72 px-10 py-2 rounded-xl bg-white/80 dark:bg-steel-800 border border-steel-200 dark:border-steel-700 placeholder:text-steel-400 focus:outline-none focus:ring-2 focus:ring-primary-500">
                <svg class="h-5 w-5 absolute left-3 text-steel-400" viewBox="0 0 24 24" fill="currentColor">
                  <path d="M11 4a7 7 0 1 1 0 14 7 7 0 0 1 0-14Zm6.32 12.9 3.39 3.39-1.42 1.42-3.39-3.39" />
                </svg>
              </div>
              <button id="themeToggle" class="inline-flex items-center gap-2 px-3 py-2 rounded-lg border border-steel-200 dark:border-steel-700 text-steel-700 dark:text-steel-100 bg-white dark:bg-steel-800">
                <svg id="sunIcon" class="h-5 w-5 hidden" viewBox="0 0 24 24" fill="currentColor">
                  <path d="M6.76 4.84 5.34 3.42 3.92 4.84l1.42 1.42 1.42-1.42zM1 13h3v-2H1v2zm10 10h2v-3h-2v3zm9-10v2h3v-2h-3zM17.24 4.84l1.42 1.42 1.42-1.42-1.42-1.42-1.42 1.42zM12 6a6 6 0 1 0 .001 12.001A6 6 0 0 0 12 6zm8.08 11.08-1.42 1.42 1.42 1.42 1.42-1.42-1.42-1.42zM4.84 17.24 3.42 18.66l1.42 1.42 1.42-1.42-1.42-1.42z" />
                </svg>
                <svg id="moonIcon" class="h-5 w-5" viewBox="0 0 24 24" fill="currentColor">
                  <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z" />
                </svg>
                <span class="hidden sm:inline">Theme</span>
              </button>
              <div class="relative">
                <button id="bellBtn" class="inline-flex items-center justify-center size-10 rounded-full border border-steel-200 dark:border-steel-700 bg-white dark:bg-steel-800 relative">
                  <svg class="h-5 w-5 text-steel-700 dark:text-steel-100" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M12 22a2 2 0 0 0 2-2h-4a2 2 0 0 0 2 2Zm6-6V11a6 6 0 0 0-12 0v5l-2 2v1h16v-1l-2-2Z" />
                  </svg>
                  <span id="notifDot" class="absolute -top-0.5 -right-0.5 size-3 bg-critical rounded-full ring-2 ring-white dark:ring-steel-900"></span>
                </button>
                <div id="notifMenu" class="hidden absolute right-0 mt-2 w-96 max-w-[90vw] bg-white dark:bg-steel-800 border border-steel-200 dark:border-steel-700 rounded-xl2 shadow-card overflow-hidden">
                  <div class="px-4 py-3 flex items-center justify-between">
                    <div class="font-semibold">Alerts</div>
                    <a href="#alerts" class="text-primary-600 hover:underline" onclick="navigate('alerts')">Open Center</a>
                  </div>
                  <div id="notifList" class="max-h-80 overflow-auto divide-y divide-steel-100 dark:divide-steel-700"></div>
                </div>
              </div>
              <div class="hidden md:flex items-center gap-3 pl-2 ml-2 border-l border-steel-200 dark:border-steel-700">
                <div class="text-right">
                  <div class="text-sm font-semibold">Alex Rivera</div>
                  <div class="text-xs text-steel-500">Chief Audit Exec</div>
                </div>
                <div class="size-10 rounded-full bg-gradient-to-br from-primary-600 to-primary-800 text-white flex items-center justify-center font-bold">AR</div>
              </div>
            </div>
          </div>
        </div>
      </header>

      <div id="mobileDrawer" class="lg:hidden fixed inset-0 z-40 hidden">
        <div class="absolute inset-0 bg-black/30" onclick="toggleMobile(false)"></div>
        <div class="absolute left-0 top-0 bottom-0 w-[85%] max-w-[320px] bg-white dark:bg-steel-800 p-4">
          <div class="flex items-center justify-between mb-4">
            <div class="flex items-center gap-3">
              <div class="h-9 w-9 rounded-full bg-primary-600 text-white flex items-center justify-center">A</div>
              <div class="font-bold">AutonomiQ</div>
            </div>
            <button class="p-2 rounded-lg border border-steel-200 dark:border-steel-700" onclick="toggleMobile(false)">Close</button>
          </div>
          <ul id="navListMobile" class="space-y-1"></ul>
        </div>
      </div>

      <main class="flex-1">
        <div class="max-w-[1400px] mx-auto p-4 md:p-6 space-y-8">
          <section id="page-dashboard" class="space-y-6">
            <div class="flex flex-wrap gap-3">
              <button id="btnAudit" class="px-4 py-2.5 rounded-xl bg-primary-600 text-white shadow-soft hover:bg-primary-700">Run Instant Audit</button>
              <button id="btnReport" class="px-4 py-2.5 rounded-xl border border-steel-200 dark:border-steel-700 bg-white dark:bg-steel-800 hover:bg-steel-50 dark:hover:bg-steel-700">Generate Report</button>
              <button id="btnAssistant" class="px-4 py-2.5 rounded-xl border border-primary-200 dark:border-primary-800 text-primary-700 dark:text-primary-300 bg-primary-50 dark:bg-primary-900/20 hover:bg-primary-100 dark:hover:bg-primary-900/30">Ask Audit Assistant</button>
            </div>

            <div class="grid grid-cols-1 sm:grid-cols-2 xl:grid-cols-4 gap-4">
              <div class="card-hover p-5 rounded-xl2 bg-white/90 dark:bg-steel-800/70 border border-steel-100 dark:border-steel-700 shadow-soft">
                <div class="flex items-center justify-between">
                  <div class="text-sm text-steel-500">Compliance Score</div>
                  <span class="text-xs px-2 py-1 rounded-full bg-green-50 text-green-700 border border-green-200 dark:bg-steel-700 dark:text-green-300 dark:border-steel-600">Healthy</span>
                </div>
                <div class="mt-4 flex items-center gap-5">
                  <div class="relative size-20 rounded-full ring-conic" style="--ring-color:#10B981; --pct:86;">
                    <div class="absolute inset-1 rounded-full bg-white dark:bg-steel-900 flex items-center justify-center text-xl font-semibold">86%</div>
                  </div>
                  <div class="text-sm">
                    <div class="text-steel-600 dark:text-steel-300">↑ 3% vs last month</div>
                    <div class="mt-2 h-10 w-28">
                      <svg viewBox="0 0 100 30" class="h-full w-full">
                        <polyline fill="none" stroke="#10B981" stroke-width="3" points="0,25 15,18 30,22 45,15 60,17 75,10 90,12 100,8" />
                      </svg>
                    </div>
                  </div>
                </div>
              </div>

              <div class="card-hover p-5 rounded-xl2 bg-white/90 dark:bg-steel-800/70 border border-steel-100 dark:border-steel-700 shadow-soft">
                <div class="flex items-center justify-between">
                  <div class="text-sm text-steel-500">High-Risk Transactions</div>
                  <span class="size-2.5 bg-critical rounded-full glow-red"></span>
                </div>
                <div class="mt-4 flex items-end justify-between">
                  <div class="text-3xl font-extrabold">128</div>
                  <div class="text-xs text-critical">+18 this week</div>
                </div>
                <div class="mt-4 grid grid-cols-8 gap-1">
                  <div class="h-8 bg-critical/70 rounded"></div>
                  <div class="h-5 bg-critical/50 rounded"></div>
                  <div class="h-7 bg-critical/60 rounded"></div>
                  <div class="h-10 bg-critical/80 rounded"></div>
                  <div class="h-6 bg-critical/60 rounded"></div>
                  <div class="h-9 bg-critical/70 rounded"></div>
                  <div class="h-4 bg-critical/40 rounded"></div>
                  <div class="h-8 bg-critical/70 rounded"></div>
                </div>
              </div>

              <div class="card-hover p-5 rounded-xl2 bg-white/90 dark:bg-steel-800/70 border border-steel-100 dark:border-steel-700 shadow-soft">
                <div class="flex items-center justify-between">
                  <div class="text-sm text-steel-500">Open Findings</div>
                  <span class="size-2.5 bg-warning rounded-full glow-yellow"></span>
                </div>
                <div class="mt-4 flex items-end justify-between">
                  <div class="text-3xl font-extrabold">42</div>
                  <div class="text-xs text-warning">7 near due</div>
                </div>
                <div class="mt-4 flex gap-2">
                  <span class="text-xs px-2 py-1 rounded-full bg-red-50 text-red-700 border border-red-200 dark:bg-steel-700 dark:text-red-300 dark:border-steel-600">Critical 5</span>
                  <span class="text-xs px-2 py-1 rounded-full bg-yellow-50 text-yellow-700 border border-yellow-200 dark:bg-steel-700 dark:text-yellow-300 dark:border-steel-600">High 17</span>
                  <span class="text-xs px-2 py-1 rounded-full bg-blue-50 text-blue-700 border border-blue-200 dark:bg-steel-700 dark:text-blue-300 dark:border-steel-600">Medium 20</span>
                </div>
              </div>

              <div class="card-hover p-5 rounded-xl2 bg-white/90 dark:bg-steel-800/70 border border-steel-100 dark:border-steel-700 shadow-soft">
                <div class="flex items-center justify-between">
                  <div class="text-sm text-steel-500">ESG Risk Index</div>
                  <span class="text-xs px-2 py-1 rounded-full bg-emerald-50 text-emerald-700 border border-emerald-200 dark:bg-steel-700 dark:text-emerald-300 dark:border-steel-600">Low</span>
                </div>
                <div class="mt-3">
                  <div class="h-2 rounded-full bg-steel-100 dark:bg-steel-700 overflow-hidden">
                    <div class="h-2 bg-gradient-to-r from-esg via-yellow-400 to-critical rounded-full" style="width: 32%"></div>
                  </div>
                  <div class="mt-2 text-sm flex items-center justify-between">
                    <span>Score 0.32</span><span class="text-steel-500">Target <span class="font-medium">≤ 0.40</span></span>
                  </div>
                </div>
              </div>
            </div>

            <div class="grid grid-cols-1 xl:grid-cols-3 gap-4">
              <div class="xl:col-span-2 p-5 rounded-xl2 bg-white/90 dark:bg-steel-800/70 border border-steel-100 dark:border-steel-700 shadow-soft">
                <div class="flex items-center justify-between">
                  <div class="font-semibold">Risk Heatmap</div>
                  <div class="text-xs text-steel-500">Processes × Risk Level</div>
                </div>
                <div id="heatmap" class="mt-4 grid grid-cols-7 gap-2">
                  <div></div>
                  <div class="text-xs text-steel-500 text-center">Very Low</div>
                  <div class="text-xs text-steel-500 text-center">Low</div>
                  <div class="text-xs text-steel-500 text-center">Moderate</div>
                  <div class="text-xs text-steel-500 text-center">Elevated</div>
                  <div class="text-xs text-steel-500 text-center">High</div>
                  <div class="text-xs text-steel-500 text-center">Severe</div>
                </div>
                <div id="heatRows" class="mt-2 space-y-2"></div>
                <div id="heatInfo" class="mt-3 text-sm text-steel-600 dark:text-steel-300"></div>
              </div>

              <div class="p-5 rounded-xl2 bg-white/90 dark:bg-steel-800/70 border border-steel-100 dark:border-steel-700 shadow-soft">
                <div class="flex items-center justify-between">
                  <div class="font-semibold">Anomaly Timeline</div>
                  <div class="text-xs text-steel-500">Last 14 days</div>
                </div>
                <div class="mt-4 overflow-x-auto">
                  <div id="timeline" class="flex items-end gap-3 min-w-[560px]"></div>
                </div>
                <div id="timelineInfo" class="mt-3 text-sm text-steel-600 dark:text-steel-300"></div>
              </div>
            </div>
          </section>

          <section id="page-agents" class="hidden space-y-6">
            <div class="grid grid-cols-1 lg:grid-cols-4 gap-4">
              <div class="lg:col-span-3 space-y-4">
                <div class="grid grid-cols-1 sm:grid-cols-2 xl:grid-cols-3 gap-4" id="agentGrid">
                  </div>
              </div>
              <div class="lg:col-span-1 p-5 rounded-xl2 bg-white/90 dark:bg-steel-800/70 border border-steel-100 dark:border-steel-700 shadow-soft">
                <div class="flex items-center justify-between">
                  <div class="font-semibold">Collaboration Feed</div>
                  <div class="text-xs text-steel-500">Live</div>
                </div>
                <div id="collabFeed" class="mt-4 space-y-3 max-h-[520px] overflow-auto"></div>
              </div>
            </div>
          </section>

          <section id="page-explore" class="hidden space-y-6">
            <div class="flex flex-col lg:flex-row gap-4">
              <form id="exploreSearchForm" class="flex-1 flex items-center gap-2" onsubmit="event.preventDefault(); applyExploreFilters();">
                <div class="relative flex-1">
                  <input id="exploreSearch" type="search" placeholder="Search transactions, processes, vendors..." class="w-full px-10 py-2.5 rounded-xl bg-white/90 dark:bg-steel-800/70 border border-steel-200 dark:border-steel-700">
                  <svg class="h-5 w-5 absolute left-3 top-2.5 text-steel-400" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M11 4a7 7 0 1 1 0 14 7 7 0 0 1 0-14Zm6.32 12.9 3.39 3.39-1.42 1.42-3.39-3.39" />
                  </svg>
                </div>
                <select id="filterRisk" class="px-3 py-2.5 rounded-xl bg-white/90 dark:bg-steel-800/70 border border-steel-200 dark:border-steel-700">
                  <option value="">Risk: Any</option>
                  <option>Low</option>
                  <option>Medium</option>
                  <option>High</option>
                  <option>Critical</option>
                </select>
                <select id="filterProcess" class="px-3 py-2.5 rounded-xl bg-white/90 dark:bg-steel-800/70 border border-steel-200 dark:border-steel-700">
                  <option value="">Process: Any</option>
                  <option>Procure-to-Pay</option>
                  <option>Order-to-Cash</option>
                  <option>Record-to-Report</option>
                  <option>IT Change</option>
                </select>
                <button class="px-4 py-2.5 rounded-xl bg-primary-600 text-white">Filter</button>
              </form>
            </div>

            <div class="grid grid-cols-1 xl:grid-cols-3 gap-4">
              <div class="xl:col-span-2 p-5 rounded-xl2 bg-white/90 dark:bg-steel-800/70 border border-steel-100 dark:border-steel-700 shadow-soft">
                <div class="flex items-center justify-between">
                  <div class="font-semibold">Anomalies</div>
                  <div class="text-xs text-steel-500">Click a row to explain</div>
                </div>
                <div class="mt-3 overflow-auto">
                  <table class="w-full text-sm">
                    <thead class="text-steel-500">
                      <tr class="border-b border-steel-100 dark:border-steel-700">
                        <th class="text-left py-2 px-2">ID</th>
                        <th class="text-left py-2 px-2 cursor-pointer" onclick="sortTable('amount')">Amount</th>
                        <th class="text-left py-2 px-2">Process</th>
                        <th class="text-left py-2 px-2 cursor-pointer" onclick="sortTable('risk')">Risk</th>
                        <th class="text-left py-2 px-2">Agent</th>
                        <th class="text-left py-2 px-2">Status</th>
                      </tr>
                    </thead>
                    <tbody id="anomalyTbody" class="divide-y divide-steel-100 dark:divide-steel-700"></tbody>
                  </table>
                </div>
              </div>

              <div class="p-5 rounded-xl2 bg-white/90 dark:bg-steel-800/70 border border-steel-100 dark:border-steel-700 shadow-soft">
                <div class="flex items-center justify-between">
                  <div class="font-semibold">Process Mining</div>
                  <div class="flex items-center gap-2 text-xs">
                    <label class="inline-flex items-center gap-1"><input type="checkbox" id="toggleAsIs" checked class="accent-primary-600">As-Is</label>
                    <label class="inline-flex items-center gap-1"><input type="checkbox" id="toggleAsDesigned" checked class="accent-primary-600">As-Designed</label>
                  </div>
                </div>
                <div id="processCanvas" class="mt-3 p-3 rounded-xl bg-steel-50 dark:bg-steel-900/40 border border-steel-100 dark:border-steel-700">
                  <svg viewBox="0 0 700 240" class="w-full h-[240px]">
                    <g id="flowDesigned" stroke="#2157d5" stroke-width="2" fill="none">
                      <rect x="20" y="30" width="120" height="40" rx="10" fill="white" class="dark:fill-steel-800" />
                      <text x="80" y="55" text-anchor="middle" fill="#2157d5" font-size="12">Order</text>
                      <line x1="140" y1="50" x2="220" y2="50" />
                      <polygon points="220,50 210,45 210,55" fill="#2157d5" />
                      <rect x="220" y="30" width="140" height="40" rx="10" fill="white" class="dark:fill-steel-800" />
                      <text x="290" y="55" text-anchor="middle" fill="#2157d5" font-size="12">Approve</text>
                      <line x1="360" y1="50" x2="450" y2="50" />
                      <polygon points="450,50 440,45 440,55" fill="#2157d5" />
                      <rect x="450" y="30" width="120" height="40" rx="10" fill="white" class="dark:fill-steel-800" />
                      <text x="510" y="55" text-anchor="middle" fill="#2157d5" font-size="12">Invoice</text>
                      <line x1="570" y1="50" x2="650" y2="50" />
                      <polygon points="650,50 640,45 640,55" fill="#2157d5" />
                      <rect x="650" y="30" width="120" height="40" rx="10" fill="white" class="dark:fill-steel-800" />
                      <text x="710" y="55" text-anchor="middle" fill="#2157d5" font-size="12">Pay</text>
                    </g>

                    <g id="flowAsIs" stroke="#F59E0B" stroke-dasharray="5 4" stroke-width="2" fill="none">
                      <rect x="20" y="140" width="120" height="40" rx="10" fill="white" class="dark:fill-steel-800" />
                      <text x="80" y="165" text-anchor="middle" fill="#F59E0B" font-size="12">Order</text>
                      <line x1="140" y1="160" x2="220" y2="160" />
                      <polygon points="220,160 210,155 210,165" fill="#F59E0B" />
                      <rect x="220" y="140" width="140" height="40" rx="10" fill="white" class="dark:fill-steel-800" />
                      <text x="290" y="165" text-anchor="middle" fill="#F59E0B" font-size="12">Approve (Skipped)</text>
                      <line x1="360" y1="160" x2="450" y2="160" />
                      <polygon points="450,160 440,155 440,165" fill="#F59E0B" />
                      <rect x="450" y="140" width="120" height="40" rx="10" fill="white" class="dark:fill-steel-800" />
                      <text x="510" y="165" text-anchor="middle" fill="#F59E0B" font-size="12">Invoice</text>
                      <line x1="570" y1="160" x2="650" y2="160" />
                      <polygon points="650,160 640,155 640,165" fill="#F59E0B" />
                      <rect x="650" y="140" width="120" height="40" rx="10" fill="white" class="dark:fill-steel-800" />
                      <text x="710" y="165" text-anchor="middle" fill="#F59E0B" font-size="12">Pay</text>
                    </g>
                  </svg>
                </div>
                <div class="mt-2 text-sm text-steel-600 dark:text-steel-300">Dashed path indicates deviations (e.g., skipped approval) detected by Process Miner.</div>
              </div>
            </div>

            <div class="p-5 rounded-xl2 bg-white/90 dark:bg-steel-800/70 border border-steel-100 dark:border-steel-700 shadow-soft">
              <div class="flex items-center justify-between">
                <div class="font-semibold">Case Timeline</div>
                <div class="text-xs text-steel-500">Click an event to view evidence</div>
              </div>
              <div id="caseTimeline" class="mt-3 flex flex-col md:flex-row md:items-center gap-4 md:gap-10"></div>
            </div>
          </section>

          <section id="page-risk" class="hidden space-y-6">
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
              <div class="p-5 rounded-xl2 bg-white/90 dark:bg-steel-800/70 border border-steel-100 dark:border-steel-700 shadow-soft">
                <div class="font-semibold">Vendor Risk</div>
                <div id="vendorHeat" class="mt-3 grid grid-cols-6 gap-2"></div>
              </div>
              <div class="p-5 rounded-xl2 bg-white/90 dark:bg-steel-800/70 border border-steel-100 dark:border-steel-700 shadow-soft">
                <div class="font-semibold">Department Risk</div>
                <div id="deptHeat" class="mt-3 grid grid-cols-6 gap-2"></div>
              </div>
              <div class="p-5 rounded-xl2 bg-white/90 dark:bg-steel-800/70 border border-steel-100 dark:border-steel-700 shadow-soft">
                <div class="font-semibold">Anomaly Clusters</div>
                <div id="clusterWrap" class="mt-3 flex flex-wrap gap-2"></div>
                <div class="mt-3 text-xs text-steel-500">Hover to see cluster size and dominant risk.</div>
              </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
              <div class="lg:col-span-2 p-5 rounded-xl2 bg-white/90 dark:bg-steel-800/70 border border-steel-100 dark:border-steel-700 shadow-soft">
                <div class="flex items-center justify-between">
                  <div class="font-semibold">Compliance Tracker</div>
                  <button class="text-primary-600 text-sm underline" onclick="openChecklist()">Drill-down checklist</button>
                </div>
                <div id="complianceList" class="mt-4 space-y-4"></div>
              </div>
              <div class="p-5 rounded-xl2 bg-white/90 dark:bg-steel-800/70 border border-steel-100 dark:border-steel-700 shadow-soft">
                <div class="font-semibold">Highlights</div>
                <ul class="mt-3 text-sm list-disc pl-5 space-y-1 text-steel-700 dark:text-steel-200">
                  <li>GDPR trending to green with DPIA improvements</li>
                  <li>SOX ITGC controls need remediation in Change Mgmt</li>
                  <li>Supplier onboarding checks reduced false positives</li>
                </ul>
              </div>
            </div>
          </section>

          <section id="page-reports" class="hidden space-y-6">
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
              <div class="lg:col-span-2 p-5 rounded-xl2 bg-white/90 dark:bg-steel-800/70 border border-steel-100 dark:border-steel-700 shadow-soft">
                <div class="flex items-center justify-between">
                  <div class="font-semibold">Automated Reports (Demo)</div>
                  <div class="text-xs text-steel-500">Preview & download sample</div>
                </div>
                <div class="mt-4 grid grid-cols-1 md:grid-cols-2 gap-4" id="reportGrid"></div>
              </div>

              <div class="p-5 rounded-xl2 bg-white/90 dark:bg-steel-800/70 border border-steel-100 dark:border-steel-700 shadow-soft">
                <div class="flex items-center justify-between">
                  <div class="font-semibold">Evidence Locker</div>
                  <label class="inline-flex items-center gap-2 px-3 py-2 rounded-lg border border-steel-200 dark:border-steel-700 bg-white dark:bg-steel-800 cursor-pointer">
                    <svg class="h-5 w-5 text-primary-600" viewBox="0 0 24 24" fill="currentColor">
                      <path d="M13 11h8v2h-8v8h-2v-8H3v-2h8V3h2v8z" />
                    </svg>
                    <span class="text-sm">Add</span>
                    <input id="evidenceInput" type="file" class="hidden" multiple>
                  </label>
                </div>
                <div class="mt-3">
                  <div id="evidenceTags" class="flex flex-wrap gap-2"></div>
                </div>
                <div id="evidenceList" class="mt-4 space-y-2 max-h-[420px] overflow-auto"></div>
                <div class="mt-2 text-[11px] text-steel-500">Local-only demo: files are not uploaded.</div>
              </div>
            </div>

            <div class="p-5 rounded-xl2 bg-white/90 dark:bg-steel-800/70 border border-steel-100 dark:border-steel-700 shadow-soft">
              <div class="flex items-center justify-between">
                <div class="font-semibold">Remediation Tracker</div>
              </div>
              <div class="mt-3 overflow-auto">
                <table class="w-full text-sm">
                  <thead class="text-steel-500">
                    <tr class="border-b border-steel-100 dark:border-steel-700">
                      <th class="text-left py-2 px-2">Finding</th>
                      <th class="text-left py-2 px-2">Owner</th>
                      <th class="text-left py-2 px-2">Due</th>
                      <th class="text-left py-2 px-2">Status</th>
                      <th class="text-left py-2 px-2">Action</th>
                    </tr>
                  </thead>
                  <tbody id="remediationBody" class="divide-y divide-steel-100 dark:divide-steel-700"></tbody>
                </table>
              </div>
            </div>
          </section>

          <section id="page-alerts" class="hidden space-y-6">
            <div class="flex items-center justify-between">
              <div class="font-semibold text-lg">Alert & Notification Center</div>
              <div class="flex items-center gap-2">
                <select id="alertSeverity" class="px-3 py-2.5 rounded-xl bg-white/90 dark:bg-steel-800/70 border border-steel-200 dark:border-steel-700">
                  <option value="">Severity: All</option>
                  <option>High</option>
                  <option>Medium</option>
                  <option>Low</option>
                </select>
                <select id="alertAgent" class="px-3 py-2.5 rounded-xl bg-white/90 dark:bg-steel-800/70 border border-steel-200 dark:border-steel-700">
                  <option value="">Agent: All</option>
                  <option>Finance</option>
                  <option>IT</option>
                  <option>Compliance</option>
                  <option>IoT</option>
                </select>
                <button class="px-4 py-2.5 rounded-xl bg-primary-600 text-white" onclick="filterAlerts()">Filter</button>
              </div>
            </div>
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
              <div class="lg:col-span-2 space-y-3" id="alertList">
                </div>
              <div class="p-5 rounded-xl2 bg-white/90 dark:bg-steel-800/70 border border-steel-100 dark:border-steel-700 shadow-soft">
                <div class="font-semibold">Channels</div>
                <div class="mt-3 space-y-2 text-sm">
                  <label class="flex items-center justify-between gap-2 p-2 rounded-lg border border-steel-200 dark:border-steel-700 bg-white/70 dark:bg-steel-900/40">
                    <div class="flex items-center gap-2">
                      <span class="px-2 py-0.5 rounded bg-indigo-100 text-indigo-700 text-xs">Teams</span>
                      Microsoft Teams
                    </div>
                    <input id="chTeams" type="checkbox" checked class="accent-primary-600">
                  </label>
                  <label class="flex items-center justify-between gap-2 p-2 rounded-lg border border-steel-200 dark:border-steel-700 bg-white/70 dark:bg-steel-900/40">
                    <div class="flex items-center gap-2">
                      <span class="px-2 py-0.5 rounded bg-sky-100 text-sky-700 text-xs">Slack</span>
                      Slack
                    </div>
                    <input id="chSlack" type="checkbox" checked class="accent-primary-600">
                  </label>
                  <label class="flex items-center justify-between gap-2 p-2 rounded-lg border border-steel-200 dark:border-steel-700 bg-white/70 dark:bg-steel-900/40">
                    <div class="flex items-center gap-2">
                      <span class="px-2 py-0.5 rounded bg-emerald-100 text-emerald-700 text-xs">Email</span>
                      Email
                    </div>
                    <input id="chEmail" type="checkbox" class="accent-primary-600">
                  </label>
                </div>
                <div class="mt-3 text-xs text-steel-500">Changes are saved locally for this demo.</div>
              </div>
            </div>
          </section>
          <section id="page-vendors" class="page hidden space-y-2 relative pt-4">
            <div class="mb-8">
              <div class="inline-flex items-center gap-1 rounded-full bg-amber-50 text-amber-900 px-3 py-1.5 text-xs font-medium border border-amber-200 shadow-soft">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-3.5 w-3.5" viewBox="0 0 20 20" fill="currentColor">
                  <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-8-4a1 1 0 100 2 1 1 0 000-2zm-2 4a1 1 0 000 2h1v3a1 1 0 102 0v-4a1 1 0 00-1-1H8z" clip-rule="evenodd" />
                </svg>
              </div>
            </div>
            <div id="app" class="space-y-2">
              </div>
            <div class="absolute top-2 right-2 flex items-center gap-1" id="roleTabs">
              </div>
      </main>

      <footer class="mt-10 py-6">
      </footer>

      <div id="feedbackModal" class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm hidden z-50">
        <div class="absolute inset-0 flex items-center justify-center px-4">
          <div class="w-full max-w-md rounded-2xl bg-white p-5 shadow-soft border border-white">
            <div class="flex items-center justify-between mb-3">
              <h3 class="text-lg font-semibold text-slate-900">Rate your experience</h3>
              <button onclick="closeFeedback()" class="rounded-full bg-slate-100 hover:bg-slate-200 text-slate-700 w-8 h-8">×</button>
            </div>
            <form onsubmit="submitFeedback(event)" class="space-y-4">
              <div>
                <label class="block text-sm font-medium text-slate-700 mb-1">Rating</label>
                <div class="flex gap-2">
                  <button type="button" data-star="1" class="star-btn text-2xl">☆</button>
                  <button type="button" data-star="2" class="star-btn text-2xl">☆</button>
                  <button type="button" data-star="3" class="star-btn text-2xl">☆</button>
                  <button type="button" data-star="4" class="star-btn text-2xl">☆</button>
                  <button type="button" data-star="5" class="star-btn text-2xl">☆</button>
                </div>
              </div>
              <div>
                <label class="block text-sm font-medium text-slate-700 mb-1">Feedback</label>
                <textarea id="feedbackComment" rows="4" placeholder="Tell us how it went..." class="w-full rounded-xl border border-slate-200 px-3 py-2 focus:ring-2 focus:ring-brand-400 outline-none"></textarea>
              </div>
              <div class="flex items-center justify-end gap-2">
                <button type="button" onclick="closeFeedback()" class="rounded-xl bg-white border border-slate-200 px-4 py-2">Cancel</button>
                <button class="rounded-xl bg-emerald-600 hover:bg-emerald-700 text-white px-4 py-2.5">Submit</button>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>
  </div>


  <script>
    // State
    const pages = [{
      id: 'dashboard',
      name: 'Dashboard',
      icon: iconGrid()
    }, {
      id: 'agents',
      name: 'Agent Hub',
      icon: iconBots()
    }, {
      id: 'explore',
      name: 'Audit Exploration',
      icon: iconSearch()
    }, {
      id: 'risk',
      name: 'Risk & Compliance',
      icon: iconShield()
    }, {
      id: 'reports',
      name: 'Reports & Evidence',
      icon: iconDoc()
    }, {
      id: 'alerts',
      name: 'Alerts',
      icon: iconBell()
    }, {
      id: 'vendors',
      name: 'Vendor Management',
      icon: iconUsers()
    }, ];
    let currentPage = 'dashboard';
    let dark = false;
    let anomalySort = {
      key: '',
      asc: true
    };
    const navClasses = "w-full text-left flex items-center gap-3 px-3 py-2.5 rounded-lg hover:bg-primary-50 dark:hover:bg-steel-700";
    const navActive = "bg-primary-600 text-white hover:bg-primary-700";
    const navInactive = "text-steel-800 dark:text-steel-100";
    // Utils
    const $ = (sel, ctx = document) => ctx.querySelector(sel);
    // Init
    document.addEventListener('DOMContentLoaded', () => {
      initTheme();
      buildNav();
      renderDashboard();
      renderAgents();
      renderExplore();
      renderRisk();
      renderReports();
      renderAlerts();
      renderVendor();

      wireBasics();
      // open dashboard by default
      navigate('dashboard');
    });

function wireBasics() {
    const btnAudit = document.getElementById('btnAudit');
    const btnReport = document.getElementById('btnReport');
    const btnAssistant = document.getElementById('btnAssistant');
    const themeToggle = document.getElementById('themeToggle');
    const bellBtn = document.getElementById('bellBtn');
    const chatToggle = document.getElementById('chatToggle');
    const toggleAsIs = document.getElementById('toggleAsIs');
    const toggleAsDesigned = document.getElementById('toggleAsDesigned');
    const mobileMenuBtn = document.getElementById('mobileMenuBtn');
    const evidenceInput = document.getElementById('evidenceInput');
    
    if (btnAudit) btnAudit.addEventListener('click', runAuditFlow);
    if (btnReport) btnReport.addEventListener('click', openReportWizard);
    if (btnAssistant) btnAssistant.addEventListener('click', () => toggleChat(true));
    if (themeToggle) themeToggle.addEventListener('click', toggleTheme);
    if (bellBtn) bellBtn.addEventListener('click', toggleNotif);
    if (chatToggle) chatToggle.addEventListener('click', () => toggleChat(true));
    if (toggleAsIs) toggleAsIs.addEventListener('change', toggleProcessLayers);
    if (toggleAsDesigned) toggleAsDesigned.addEventListener('change', toggleProcessLayers);
    if (mobileMenuBtn) mobileMenuBtn.addEventListener('click', () => toggleMobile(true));
    if (evidenceInput) evidenceInput.addEventListener('change', handleEvidence);
}

    // THEME
    function initTheme() {
      const saved = localStorage.getItem('theme');
      dark = saved ? (saved === 'dark') : window.matchMedia('(prefers-color-scheme: dark)').matches;
      document.documentElement.classList.toggle('dark', dark);
      document.getElementById('sunIcon').classList.toggle('hidden', !dark);
      document.getElementById('moonIcon').classList.toggle('hidden', dark);
    }

    function toggleTheme() {
      dark = !dark;
      document.documentElement.classList.toggle('dark', dark);
      localStorage.setItem('theme', dark ? 'dark' : 'light');
      document.getElementById('sunIcon').classList.toggle('hidden', !dark);
      document.getElementById('moonIcon').classList.toggle('hidden', dark);
    }

    // NAV
    function buildNav() {
      const list = document.getElementById('navList');
      const listM = document.getElementById('navListMobile');
      pages.forEach(p => {
        const li = document.createElement('li');
        li.innerHTML = `<button class="${navClasses} ${p.id===currentPage?navActive:navInactive}" onclick="navigate('${p.id}')">
          <span class="inline-flex items-center justify-center size-7 rounded-md border border-transparent ${p.id===currentPage?'bg-white/20 text-white':'bg-white dark:bg-steel-800 text-primary-600 dark:text-primary-300 border-steel-200 dark:border-steel-700'}">${p.icon}</span>
          <span>${p.name}</span>
        </button>`;
        list.appendChild(li);

        const lim = document.createElement('li');
        lim.innerHTML = `<button class="${navClasses} ${p.id===currentPage?navActive:navInactive}" onclick="navigate('${p.id}'); toggleMobile(false);">
          <span class="inline-flex items-center justify-center size-7 rounded-md border border-transparent ${p.id===currentPage?'bg-white/20 text-white':'bg-white dark:bg-steel-800 text-primary-600 dark:text-primary-300 border-steel-200 dark:border-steel-700'}">${p.icon}</span>
          <span>${p.name}</span>
        </button>`;
        listM.appendChild(lim);
      });
    }

    function navigate(id) {
      currentPage = id;
      pages.forEach(p => {
        document.getElementById('page-' + p.id).classList.toggle('hidden', p.id !== id);
      });
      // Update title/icon
      const page = pages.find(x => x.id === id);
      document.getElementById('pageTitle').textContent = page.name;
      document.getElementById('pageIcon').innerHTML = page.icon;
      // Update active nav
      [...document.querySelectorAll('#navList button')].forEach((btn, i) => {
        const pid = pages[i].id;
        btn.className = `${navClasses} ${pid===currentPage?navActive:navInactive}`;
        btn.querySelector('span').className = `inline-flex items-center justify-center size-7 rounded-md border border-transparent ${pid===currentPage?'bg-white/20 text-white':'bg-white dark:bg-steel-800 text-primary-600 dark:text-primary-300 border-steel-200 dark:border-steel-700'}`;
      });
      [...document.querySelectorAll('#navListMobile button')].forEach((btn, i) => {
        const pid = pages[i].id;
        btn.className = `${navClasses} ${pid===currentPage?navActive:navInactive}`;
        btn.querySelector('span').className = `inline-flex items-center justify-center size-7 rounded-md border border-transparent ${pid===currentPage?'bg-white/20 text-white':'bg-white dark:bg-steel-800 text-primary-600 dark:text-primary-300 border-steel-200 dark:border-steel-700'}`;
      });
    }

    function toggleMobile(open) {
      document.getElementById('mobileDrawer').classList.toggle('hidden', !open);
    }

    // NOTIFS
    const notifData = [{
      id: 1,
      sev: 'High',
      agent: 'IT',
      msg: 'Admin access granted without approval (Change-1234)',
      time: '2m',
      ch: ['Teams', 'Slack']
    }, {
      id: 2,
      sev: 'Medium',
      agent: 'Finance',
      msg: 'Round-dollar invoice detected > $50k',
      time: '15m',
      ch: ['Slack']
    }, {
      id: 3,
      sev: 'Low',
      agent: 'Compliance',
      msg: 'GDPR DPIA reminder due in 3 days',
      time: '1h',
      ch: ['Email']
    }, {
      id: 4,
      sev: 'High',
      agent: 'IoT',
      msg: 'Plant sensor outlier in torque variance',
      time: '3h',
      ch: ['Teams']
    }, ];

    function toggleNotif() {
      const el = document.getElementById('notifMenu');
      el.classList.toggle('hidden');
      renderNotif();
      if (!el.classList.contains('hidden')) document.getElementById('notifDot').style.display = 'none';
    }

    function renderNotif() {
      const wrap = document.getElementById('notifList');
      wrap.innerHTML = '';
      notifData.forEach(n => {
        const sevColor = n.sev === 'High' ? 'bg-red-100 text-red-700' : n.sev === 'Medium' ? 'bg-yellow-100 text-yellow-700' : 'bg-green-100 text-green-700';
        const item = document.createElement('div');
        item.className = 'p-3 hover:bg-steel-50 dark:hover:bg-steel-700/40';
        item.innerHTML = `
          <div class="flex items-center justify-between">
            <div class="text-sm">${n.msg}</div>
            <span class="text-[11px] text-steel-500">${n.time}</span>
          </div>
          <div class="mt-1 flex items-center gap-2">
            <span class="text-[11px] px-1.5 py-0.5 rounded ${sevColor}">${n.sev}</span>
            <span class="text-[11px] px-1.5 py-0.5 rounded bg-primary-50 text-primary-700 dark:bg-primary-900/30 dark:text-primary-300">${n.agent}</span>
            <div class="ml-auto flex items-center gap-1">${n.ch.map(c=>`<span class="text-[10px] px-1.5 py-0.5 rounded bg-steel-100 text-steel-700 dark:bg-steel-700 dark:text-steel-200">${c}</span>`).join('')}</div>
          </div>
        `;
        wrap.appendChild(item);
      });
    }

    // DASHBOARD
    function renderDashboard() {
      // Heatmap headers already present; add rows
      const processes = ['Procure-to-Pay', 'Order-to-Cash', 'Record-to-Report', 'IT Change', 'Asset Mgmt'];
      const levels = ['Very Low', 'Low', 'Moderate', 'Elevated', 'High', 'Severe'];
      const heatRows = document.getElementById('heatRows');
      heatRows.innerHTML = '';
      processes.forEach((p, ri) => {
        const row = document.createElement('div');
        row.className = 'grid grid-cols-7 gap-2 items-center';
        row.innerHTML = `<div class="text-xs text-steel-600 dark:text-steel-300">${p}</div>`;
        levels.forEach((l, ci) => {
          const riskScore = Math.round((Math.sin((ri + 1) * (ci + 1)) + 1) * 50); // 0..100 demo
          const color = riskScore > 75 ? 'bg-critical/80' : riskScore > 55 ? 'bg-warning/80' : riskScore > 35 ? 'bg-yellow-400/60' : 'bg-emerald-400/70';
          const cell = document.createElement('button');
          cell.className = `heat-cell transition shadow-soft text-xs text-white px-2 py-6 rounded-lg ${color}`;
          cell.textContent = riskScore;
          cell.title = `${p} — ${l}`;
          cell.onclick = () => {
            document.getElementById('heatInfo').textContent = `${p} at ${l}: risk score ${riskScore}. Click "Audit Exploration" for drill-down.`;
          };
          row.appendChild(cell);
        });
        heatRows.appendChild(row);
      });

      // Timeline
      const timeline = document.getElementById('timeline');
      timeline.innerHTML = '';
      const days = 14;
      for (let i = 0; i < days; i++) {
        const val = Math.floor(Math.random() * 10);
        const sev = val > 7 ? 'critical' : val > 4 ? 'warning' : 'compliant';
        const bar = document.createElement('div');
        bar.className = `w-6 rounded-t-md ${sev==='critical'?'bg-critical':sev==='warning'?'bg-warning':'bg-emerald-400'}`;
        bar.style.height = `${10 + val*8}px`;
        bar.title = `${days-i}d ago: ${val} anomalies`;
        bar.onclick = () => document.getElementById('timelineInfo').textContent = `${val} anomalies detected ${days - i} days ago`;
        timeline.appendChild(bar);
      }
    }

    // AGENTS
    const agentDefs = [{
      name: 'Finance Auditor',
      status: 'Active',
      conf: 0.93,
      findings: ['$50k duplicate invoice', 'Missing 3-way match', 'Round-dollar approvals'],
      tag: 'Finance'
    }, {
      name: 'Process Miner',
      status: 'Scanning',
      conf: 0.88,
      findings: ['Skipped approval path', 'Rework loop O2C', 'Bottleneck in GRN'],
      tag: 'Process'
    }, {
      name: 'IT Auditor',
      status: 'Active',
      conf: 0.91,
      findings: ['PRD change without CAB', 'SoD violation', 'Excessive admin rights'],
      tag: 'IT'
    }, {
      name: 'Compliance Checker',
      status: 'Idle',
      conf: 0.87,
      findings: ['GDPR DPIA overdue', 'ISO27001 A.9 gap', 'ESG supplier doc'],
      tag: 'Compliance'
    }, {
      name: 'IoT Auditor',
      status: 'Active',
      conf: 0.82,
      findings: ['Torque variance outlier', 'Line 3 sensor drift'],
      tag: 'IoT'
    }, ];

    function renderAgents() {
      const grid = document.getElementById('agentGrid');
      grid.innerHTML = '';
      agentDefs.forEach((a, i) => {
        const card = document.createElement('div');
        card.className = 'card-hover p-5 rounded-xl2 bg-white/90 dark:bg-steel-800/70 border border-steel-100 dark:border-steel-700 shadow-soft flex flex-col';
        const statusDot = a.status === 'Active' ? 'bg-emerald-500' : a.status === 'Scanning' ? 'bg-warning' : 'bg-steel-400';
        card.innerHTML = `
          <div class="flex items-start justify-between">
            <div>
              <div class="font-semibold">${a.name}</div>
              <div class="mt-1 text-xs text-steel-500 flex items-center gap-2">
                <span class="size-2.5 rounded-full ${statusDot}"></span>${a.status}
              </div>
            </div>
            <div class="relative size-14 rounded-full ring-conic" style="--ring-color:#2157d5; --pct:${a.conf*100}">
              <div class="absolute inset-1 rounded-full bg-white dark:bg-steel-900 flex items-center justify-center text-sm font-semibold">${Math.round(a.conf*100)}%</div>
            </div>
          </div>
          <ul class="mt-4 text-sm space-y-1">${a.findings.slice(0,3).map(f=>`<li class="flex items-center gap-2"><span class="size-1.5 rounded-full bg-primary-600"></span>${f}</li>`).join('')}</ul>
          <div class="mt-4 flex items-center gap-2">
            <button class="px-3 py-2 rounded-lg bg-primary-600 text-white text-sm" onclick="openAgentExplain(${i})">Explain</button>
            <button class="px-3 py-2 rounded-lg border border-steel-200 dark:border-steel-700 text-sm" onclick="pushCollab('${a.name}','Shared insights to ${a.tag}')">Share</button>
          </div>
        `;
        grid.appendChild(card);
      });

      // Collaboration feed
      const seed = [{
        agent: 'Finance Auditor',
        text: 'Flagged 3 duplicate vendors with overlapping IBANs',
        time: '2m'
      }, {
        agent: 'Process Miner',
        text: 'Detected skipped approvals in P2P for 12 cases',
        time: '14m'
      }, {
        agent: 'IT Auditor',
        text: 'Found SoD conflict between AP and Vendor Master roles',
        time: '28m'
      }, ];
      const feed = document.getElementById('collabFeed');
      feed.innerHTML = '';
      seed.forEach(s => appendFeed(s.agent, s.text, s.time));
    }

    function pushCollab(agent, text) {
      appendFeed(agent, text, 'now');
    }

    function appendFeed(agent, text, time) {
      const feed = document.getElementById('collabFeed');
      const item = document.createElement('div');
      item.className = 'p-3 rounded-lg border border-steel-100 dark:border-steel-700 bg-white/60 dark:bg-steel-900/30';
      item.innerHTML = `
        <div class="text-sm"><span class="font-semibold">${agent}</span> — ${text}</div>
        <div class="text-xs text-steel-500 mt-1">${time}</div>
      `;
      feed.prepend(item);
    }

    function openAgentExplain(i) {
      const a = agentDefs[i];
      openModal('Agent Explainability', `
        <div class="space-y-4">
          <div class="flex items-center gap-3">
            <div class="font-semibold">${a.name}</div>
            <div class="text-xs px-2 py-1 rounded-full bg-primary-50 text-primary-700 dark:bg-primary-900/30 dark:text-primary-300 border border-primary-100 dark:border-primary-800">Confidence ${Math.round(a.conf*100)}%</div>
          </div>
          <div class="text-sm text-steel-700 dark:text-steel-200">Reasoning</div>
          <div class="p-3 rounded-lg bg-steel-50 dark:bg-steel-900/40 border border-steel-100 dark:border-steel-700 text-sm">
            Based on pattern deviations across 90 days, with emphasis on seasonality-adjusted thresholds and peer benchmarking.
          </div>
          <div class="text-sm text-steel-700 dark:text-steel-200">Linked Evidence</div>
          <ul class="text-sm list-disc pl-5 space-y-1">
            <li>Audit Log Exports (ITSM Change-1234)</li>
            <li>ERP Invoice Sample (INV-50811)</li>
            <li>Supplier Onboarding Checklist (DPIA-42)</li>
          </ul>
        </div>
      `, `<button class="px-4 py-2.5 rounded-lg bg-primary-600 text-white" onclick="closeModal()">Close</button>`);
    }

    // EXPLORE
    const anomalies = [{
      id: 'TX-1001',
      amount: 51234,
      process: 'Procure-to-Pay',
      risk: 'High',
      agent: 'Finance Auditor',
      status: 'Open',
      evidence: ['INV-501', 'PO-184']
    }, {
      id: 'TX-1002',
      amount: 980,
      process: 'Order-to-Cash',
      risk: 'Low',
      agent: 'Process Miner',
      status: 'In Progress',
      evidence: ['ORD-11']
    }, {
      id: 'TX-1003',
      amount: 75220,
      process: 'Record-to-Report',
      risk: 'Critical',
      agent: 'Finance Auditor',
      status: 'Open',
      evidence: ['JE-77', 'ACC-42']
    }, {
      id: 'TX-1004',
      amount: 14050,
      process: 'IT Change',
      risk: 'Medium',
      agent: 'IT Auditor',
      status: 'Open',
      evidence: ['CHG-2103']
    }, {
      id: 'TX-1005',
      amount: 2305,
      process: 'Procure-to-Pay',
      risk: 'Medium',
      agent: 'Compliance Checker',
      status: 'Closed',
      evidence: ['DPIA-12']
    }, {
      id: 'TX-1006',
      amount: 50500,
      process: 'Order-to-Cash',
      risk: 'High',
      agent: 'Process Miner',
      status: 'In Progress',
      evidence: ['OC-89']
    }, ];

    function renderExplore() {
      renderAnomalyTable(anomalies);
      buildCaseTimeline();
    }

    function riskPill(r) {
      const map = {
        Low: 'bg-emerald-50 text-emerald-700 border-emerald-200',
        Medium: 'bg-yellow-50 text-yellow-700 border-yellow-200',
        High: 'bg-orange-50 text-orange-700 border-orange-200',
        Critical: 'bg-red-50 text-red-700 border-red-200'
      };
      return `<span class="text-xs px-2 py-1 rounded-full border ${map[r]}">${r}</span>`;
    }

    function renderAnomalyTable(rows) {
      const body = document.getElementById('anomalyTbody');
      body.innerHTML = '';
      rows.forEach((r, idx) => {
        const tr = document.createElement('tr');
        tr.className = 'hover:bg-steel-50 dark:hover:bg-steel-700/40';
        tr.innerHTML = `
          <td class="py-2 px-2">${r.id}</td>
          <td class="py-2 px-2">$${r.amount.toLocaleString()}</td>
          <td class="py-2 px-2">${r.process}</td>
          <td class="py-2 px-2">${riskPill(r.risk)}</td>
          <td class="py-2 px-2">${r.agent}</td>
          <td class="py-2 px-2">${r.status}</td>
        `;
        tr.onclick = () => openExplainRow(r);
        body.appendChild(tr);
      });
    }

    function openExplainRow(r) {
      openModal(`Explain ${r.id}`, `
        <div class="space-y-3">
          <div class="text-sm">Amount <span class="font-semibold">$${r.amount.toLocaleString()}</span>, ${r.process} — ${riskPill(r.risk)}</div>
          <div class="text-sm">Reasoning</div>
          <div class="p-3 rounded-lg bg-steel-50 dark:bg-steel-900/40 border border-steel-100 dark:border-steel-700 text-sm">
            Detected outlier vs peer transactions (z-score &gt; 3), vendor master matched with duplicated IBAN pattern, approval step possibly skipped.
          </div>
          <div class="text-sm">Evidence</div>
          <div class="flex flex-wrap gap-2">${r.evidence.map(e=>`<span class="text-xs px-2 py-1 rounded-full bg-primary-50 text-primary-700 dark:bg-primary-900/30 dark:text-primary-300 border border-primary-100 dark:border-primary-800">${e}</span>`).join('')}</div>
        </div>
      `, `<button class="px-4 py-2.5 rounded-lg bg-primary-600 text-white" onclick="closeModal()">Close</button>`);
    }

    function sortTable(key) {
      anomalySort.asc = anomalySort.key === key ? !anomalySort.asc : true;
      anomalySort.key = key;
      const rows = [...anomalies];
      if (key === 'amount') rows.sort((a, b) => anomalySort.asc ? a.amount - b.amount : b.amount - a.amount);
      if (key === 'risk') {
        const order = {
          Low: 1,
          Medium: 2,
          High: 3,
          Critical: 4
        };
        rows.sort((a, b) => anomalySort.asc ? order[a.risk] - order[b.risk] : order[b.risk] - order[a.risk]);
      }
      renderAnomalyTable(rows);
    }

    function applyExploreFilters() {
      const q = document.getElementById('exploreSearch').value.toLowerCase();
      const r = document.getElementById('filterRisk').value;
      const p = document.getElementById('filterProcess').value;
      const filtered = anomalies.filter(x =>
        (!q || JSON.stringify(x).toLowerCase().includes(q)) &&
        (!r || x.risk === r) &&
        (!p || x.process === p)
      );
      renderAnomalyTable(filtered);
    }

    function buildCaseTimeline() {
      const events = [{
        when: 'T-5d',
        name: 'Order Created',
        ev: ['ORD-11']
      }, {
        when: 'T-4d',
        name: 'Approval',
        ev: ['APR-09']
      }, {
        when: 'T-2d',
        name: 'Invoice Received',
        ev: ['INV-501']
      }, {
        when: 'T-1d',
        name: '3-way Match',
        ev: ['PO-184', 'GRN-07']
      }, {
        when: 'T',
        name: 'Payment',
        ev: ['PAY-508']
      }, ];
      const wrap = document.getElementById('caseTimeline');
      wrap.innerHTML = '';
      events.forEach((e, i) => {
        const block = document.createElement('div');
        block.className = 'flex items-center gap-3';
        block.innerHTML = `
          <div class="text-xs text-steel-500 w-10">${e.when}</div>
          <div class="flex items-center gap-3">
            <div class="size-3 rounded-full ${i<events.length-1?'bg-emerald-400':'bg-warning'}"></div>
            <button class="px-3 py-1.5 rounded-lg border border-steel-200 dark:border-steel-700 hover:bg-steel-50 dark:hover:bg-steel-700/40 text-sm">${e.name}</button>
          </div>
        `;
        block.querySelector('button').onclick = () => openModal(e.name, `
          <div class="text-sm mb-2">Evidence attachments</div>
          <div class="flex flex-wrap gap-2">${e.ev.map(v=>`<span class="text-xs px-2 py-1 rounded-full bg-primary-50 text-primary-700 dark:bg-primary-900/30 dark:text-primary-300 border border-primary-100 dark:border-primary-800">${v}</span>`).join('')}</div>
        `, `<button class="px-4 py-2.5 rounded-lg bg-primary-600 text-white" onclick="closeModal()">Close</button>`);
        wrap.appendChild(block);
      });
    }

    // RISK & COMPLIANCE
    function renderRisk() {
      // Vendor heat
      const vendor = document.getElementById('vendorHeat');
      vendor.innerHTML = '';
      ['A', 'B', 'C', 'D', 'E', 'F', 'G', 'H', 'I', 'J', 'K', 'L'].forEach((v, i) => {
        const score = Math.floor(Math.random() * 100);
        const color = score > 80 ? 'bg-critical/80' : score > 60 ? 'bg-warning/80' : score > 40 ? 'bg-yellow-400/70' : 'bg-emerald-400/80';
        const cell = document.createElement('div');
        cell.className = `heat-cell transition text-white text-xs text-center py-6 rounded-lg ${color}`;
        cell.textContent = `V${v}`;
        cell.title = `Vendor ${v} — ${score}`;
        vendor.appendChild(cell);
      });
      // Department heat
      const dept = document.getElementById('deptHeat');
      dept.innerHTML = '';
      ['IT', 'Finance', 'Ops', 'Plant', 'HR', 'Sales', 'Legal', 'QA', 'Supply'].forEach((d, i) => {
        const score = Math.floor(Math.random() * 100);
        const color = score > 80 ? 'bg-critical/80' : score > 60 ? 'bg-warning/80' : score > 40 ? 'bg-yellow-400/70' : 'bg-emerald-400/80';
        const cell = document.createElement('div');
        cell.className = `heat-cell transition text-white text-xs text-center py-6 rounded-lg ${color}`;
        cell.textContent = d;
        cell.title = `${d} — ${score}`;
        dept.appendChild(cell);
      });
      // Clusters
      const cl = document.getElementById('clusterWrap');
      cl.innerHTML = '';
      for (let i = 1; i <= 12; i++) {
        const size = 28 + Math.random() * 22;
        const dom = ['Critical', 'High', 'Medium'][Math.floor(Math.random() * 3)];
        const bg = dom === 'Critical' ? 'bg-red-500/80' : dom === 'High' ? 'bg-orange-500/80' : 'bg-yellow-500/70';
        const b = document.createElement('div');
        b.className = `rounded-full ${bg} text-white text-xs flex items-center justify-center`;
        b.style.width = `${size}px`;
        b.style.height = `${size}px`;
        b.title = `Cluster #${i} — ${dom}`;
        b.textContent = i;
        cl.appendChild(b);
      }
      // Compliance tracker
      const finalized_items = [{
        k: 'SOX',
        pct: 72,
        desc: 'ITGC Change Mgmt controls'
      }, {
        k: 'GDPR',
        pct: 84,
        desc: 'Records of Processing, DPIA coverage'
      }, {
        k: 'ISO 27001',
        pct: 66,
        desc: 'Access Control & A.12'
      }, {
        k: 'ESG',
        pct: 78,
        desc: 'Supplier disclosures & emissions'
      }, ];
      const list = document.getElementById('complianceList');
      list.innerHTML = '';
      finalized_items.forEach(it => {
        const row = document.createElement('div');
        row.className = 'p-3 rounded-xl border border-steel-100 dark:border-steel-700 bg-white/60 dark:bg-steel-900/30';
        row.innerHTML = `
          <div class="flex items-center justify-between">
            <div class="font-medium">${it.k}</div>
            <div class="text-sm text-steel-500">${it.desc}</div>
          </div>
          <div class="mt-2 h-2 rounded-full bg-steel-100 dark:bg-steel-700 overflow-hidden">
            <div class="h-2 bg-gradient-to-r from-emerald-400 via-yellow-400 to-red-500" style="width:${it.pct}%"></div>
          </div>
          <div class="mt-1 text-xs text-steel-500">${it.pct}% complete</div>
        `;
        list.appendChild(row);
      });
    }

    function openChecklist() {
      const body = document.getElementById('drawerBody');
      body.innerHTML = `
        <div class="text-sm text-steel-600 dark:text-steel-300 mb-3">Mark finalized_items to track progress across frameworks.</div>
        ${['Access control policy','Change approval documented','Vendor DPIA completed','Backup & recovery tested','SoD conflicts reviewed','Incident response drill'].map((t,i)=>`
          <label class="flex items-center justify-between p-2 rounded-lg border border-steel-200 dark:border-steel-700 mb-2 bg-white/70 dark:bg-steel-900/40">
            <span class="text-sm">${t}</span>
            <input type="checkbox" class="accent-primary-600" ${i%2?'checked':''}>
          </label>
        `).join('')}
      `;
      document.getElementById('drawer').classList.remove('translate-x-full');
    }

    function closeDrawer() {
      document.getElementById('drawer').classList.add('translate-x-full');
    }

    function saveChecklist() {
      closeDrawer();
      toast('Checklist saved');
    }

    // REPORTS & EVIDENCE
    function renderReports() {
      const grid = document.getElementById('reportGrid');
      grid.innerHTML = '';
      const finalized_items = [{
        name: 'Executive Summary',
        type: 'PDF',
        pages: 3
      }, {
        name: 'Detailed Findings',
        type: 'PDF',
        pages: 12
      }, {
        name: 'Control Effectiveness',
        type: 'Excel',
        pages: 1
      }, {
        name: 'Remediation Plan',
        type: 'PDF',
        pages: 5
      }, ];
      finalized_items.forEach((it, i) => {
        const card = document.createElement('div');
        card.className = 'p-4 rounded-xl border border-steel-100 dark:border-steel-700 bg-white/80 dark:bg-steel-900/30';
        card.innerHTML = `
          <div class="flex items-center justify-between">
            <div class="font-medium">${it.name}</div>
            <span class="text-xs px-2 py-1 rounded-full bg-steel-100 text-steel-700 dark:bg-steel-700 dark:text-steel-200">${it.type}</span>
          </div>
          <div class="mt-2 text-sm text-steel-500">${it.pages} page${it.pages>1?'s':''} preview</div>
          <div class="mt-3 flex items-center gap-2">
            <button class="px-3 py-2 rounded-lg bg-primary-600 text-white text-sm" onclick="previewReport('${it.name}', ${it.pages})">Preview</button>
            <button class="px-3 py-2 rounded-lg border border-steel-200 dark:border-steel-700 text-sm" onclick="downloadSample('${it.name}')">Download sample</button>
          </div>
        `;
        grid.appendChild(card);
      });

      // Evidence tags/filter
      ['PO', 'INV', 'JE', 'DPIA', 'CHG', 'LOG'].forEach(t => addTagChip(t));
      renderEvidence();
    }

    function previewReport(name, pages) {
      const slides = Array.from({
        length: pages
      }).map((_, i) => `
        <div class="p-4 rounded-xl border border-steel-100 dark:border-steel-700 bg-white/90 dark:bg-steel-900/40">
          <div class="text-sm font-semibold mb-2">${name} — Page ${i+1}</div>
          <div class="h-40 rounded-lg bg-gradient-to-br from-steel-50 to-white dark:from-steel-900/30 dark:to-steel-900/10 flex items-center justify-center text-steel-500">Sample preview content</div>
        </div>
      `).join('');
      openModal(`${name} (Demo Preview)`, `<div class="space-y-3">${slides}</div>`, `<button class="px-4 py-2.5 rounded-lg bg-primary-600 text-white" onclick="closeModal()">Close</button>`);
    }

    function downloadSample(name) {
      const content = `${name}\nGenerated: ${new Date().toISOString()}\nThis is a demo sample file.`;
      const blob = new Blob([content], {
        type: 'text/plain'
      });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = name.replace(/\s+/g, '_') + '_Sample.txt';
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
      toast('Sample downloaded');
    }

    // Evidence
    const evidenceStore = [{
      id: 1,
      name: 'INV-501.pdf',
      tags: ['INV'],
      date: '2025-09-01'
    }, {
      id: 2,
      name: 'PO-184.csv',
      tags: ['PO'],
      date: '2025-09-02'
    }, {
      id: 3,
      name: 'CHG-2103.log',
      tags: ['CHG', 'LOG'],
      date: '2025-09-03'
    }, {
      id: 4,
      name: 'DPIA-42.docx',
      tags: ['DPIA'],
      date: '2025-09-04'
    }, ];
    let activeTag = '';

    function addTagChip(tag) {
      const wrap = document.getElementById('evidenceTags');
      const chip = document.createElement('button');
      chip.className = 'text-xs px-2 py-1 rounded-full border border-steel-200 dark:border-steel-700 bg-white dark:bg-steel-900';
      chip.textContent = tag;
      chip.onclick = () => {
        activeTag = activeTag === tag ? '' : tag;
        [...wrap.children].forEach(c => c.classList.remove('bg-primary-50', 'dark:bg-primary-900/30', 'text-primary-700', 'dark:text-primary-300'));
        if (activeTag) {
          chip.classList.add('bg-primary-50', 'dark:bg-primary-900/30', 'text-primary-700', 'dark:text-primary-300');
        }
        renderEvidence();
      }
      wrap.appendChild(chip);
    }

    function renderEvidence() {
      const list = document.getElementById('evidenceList');
      list.innerHTML = '';
      evidenceStore.filter(e => !activeTag || e.tags.includes(activeTag)).forEach(e => {
        const row = document.createElement('div');
        row.className = 'p-3 rounded-lg border border-steel-100 dark:border-steel-700 bg-white/70 dark:bg-steel-900/30 flex items-center justify-between';
        row.innerHTML = `
          <div>
            <div class="text-sm font-medium">${e.name}</div>
            <div class="mt-1 text-xs text-steel-500 flex items-center gap-2">${e.tags.map(t=>`<span class="px-1.5 py-0.5 rounded bg-steel-100 text-steel-700 dark:bg-steel-700 dark:text-steel-200">${t}</span>`).join('')} <span>${e.date}</span></div>
          </div>
          <div class="flex items-center gap-2">
            <button class="px-2 py-1 rounded-lg border border-steel-200 dark:border-steel-700 text-sm" onclick="previewEvidence('${e.name}')">Preview</button>
            <button class="px-2 py-1 rounded-lg bg-primary-600 text-white text-sm" onclick="linkEvidence('${e.name}')">Link</button>
          </div>
        `;
        list.appendChild(row);
      });
    }

    function handleEvidence(evt) {
      const files = [...evt.target.files];
      files.forEach((f, i) => {
        evidenceStore.push({
          id: Date.now() + i,
          name: f.name,
          tags: ['LOG'],
          date: new Date().toISOString().slice(0, 10)
        });
      });
      renderEvidence();
      toast(`${files.length} item(s) added (local)`);
      evt.target.value = '';
    }

    function previewEvidence(name) {
      openModal('Evidence Preview', `
        <div class="text-sm mb-2">${name}</div>
        <div class="h-48 rounded-lg bg-gradient-to-br from-steel-50 to-white dark:from-steel-900/30 dark:to-steel-900/10 flex items-center justify-center text-steel-500">Preview placeholder</div>
      `, `<button class="px-4 py-2.5 rounded-lg bg-primary-600 text-white" onclick="closeModal()">Close</button>`);
    }

    function linkEvidence(name) {
      toast(`${name} linked to case`);
    }

    // REMEDIATION
    const remediation = [{
      id: 1,
      title: 'Duplicate vendor cleanup',
      owner: 'Priya',
      due: '2025-10-05',
      status: 'Open'
    }, {
      id: 2,
      title: 'Change Mgmt CAB enforcement',
      owner: 'Marco',
      due: '2025-09-28',
      status: 'In Progress'
    }, {
      id: 3,
      title: 'SoD matrix review',
      owner: 'Li Wei',
      due: '2025-10-12',
      status: 'Open'
    }, ];

    function renderRemediation() {
      const body = document.getElementById('remediationBody');
      body.innerHTML = '';
      remediation.forEach((r, i) => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td class="py-2 px-2">${r.title}</td>
          <td class="py-2 px-2">${r.owner}</td>
          <td class="py-2 px-2">${r.due}</td>
          <td class="py-2 px-2">${statusBadge(r.status)}</td>
          <td class="py-2 px-2">
            <select class="px-2 py-1 rounded-lg border border-steel-200 dark:border-steel-700 bg-white dark:bg-steel-900 text-sm" onchange="updateStatus(${i}, this.value)">
              ${['Open','In Progress','Closed'].map(s=>`<option ${s===r.status?'selected':''}>${s}</option>`).join('')}
            </select>
          </td>
        `;
        body.appendChild(row);
      });
    }

    function statusBadge(status) {
      const map = {
        'Submitted': 'sky',
        'InReview': 'violet',
        'SentForUserConfirmation': 'amber',
        'UserConfirmed': 'emerald',
        'RFQSent': 'indigo',
        'QuotesReceived': 'cyan',
        'Shortlisted': 'purple',
        'WinnerSelected': 'pink',
        'ContractSent': 'pink',
        'Closed': 'slate'
      };
      const color = map[status] || 'slate';
      return `<span class="inline-flex items-center gap-1 px-2 py-0.5 rounded-full text-xs font-medium bg-${color}-100 text-${color}-800 border border-${color}-200"><span class="h-1.5 w-1.5 rounded-full bg-${color}-500"></span>${status}</span>`;
    }

    function updateStatus(i, val) {
      remediation[i].status = val;
      renderRemediation();
      toast('Status updated');
    }

    // ALERTS
    const alertStore = [{
      id: 101,
      sev: 'High',
      agent: 'Finance',
      text: 'Unusual vendor payment pattern (3 spikes)',
      time: 'Today'
    }, {
      id: 102,
      sev: 'Medium',
      agent: 'IT',
      text: 'Change merged without reviewer',
      time: 'Today'
    }, {
      id: 103,
      sev: 'Low',
      agent: 'Compliance',
      text: 'ISO control review due',
      time: 'Yesterday'
    }, {
      id: 104,
      sev: 'High',
      agent: 'IoT',
      text: 'Machine vibration outlier cluster',
      time: 'Yesterday'
    }, {
      id: 105,
      sev: 'Medium',
      agent: 'Finance',
      text: 'Round-dollar invoices > threshold',
      time: '2 days'
    }, ];

    function renderAlerts() {
      const list = document.getElementById('alertList');
      list.innerHTML = '';
      const groups = {};
      alertStore.forEach(a => {
        groups[a.agent] = groups[a.agent] || [];
        groups[a.agent].push(a);
      });
      Object.keys(groups).forEach(agent => {
        const box = document.createElement('div');
        box.className = 'p-4 rounded-xl border border-steel-100 dark:border-steel-700 bg-white/70 dark:bg-steel-900/30';
        const finalized_items = groups[agent].map(a => `
          <div class="p-3 rounded-lg border border-steel-100 dark:border-steel-700 bg-white/60 dark:bg-steel-900/40 flex items-center justify-between">
            <div class="text-sm">${a.text}</div>
            <div class="flex items-center gap-2">
              ${sevTag(a.sev)}
              <span class="text-xs text-steel-500">${a.time}</span>
              <button class="px-2 py-1 rounded-lg border border-steel-200 dark:border-steel-700 text-xs" onclick="markAlert(${a.id})">Mark read</button>
            </div>
          </div>
        `).join('');
        box.innerHTML = `
          <div class="flex items-center justify-between mb-3">
            <div class="font-medium">${agent} Agent</div>
            <div class="text-xs text-steel-500">${groups[agent].length} alerts</div>
          </div>
          <div class="space-y-2">${finalized_items}</div>
        `;
        list.appendChild(box);
      });
    }

    function sevTag(s) {
      const map = {
        High: 'bg-red-100 text-red-700',
        Medium: 'bg-yellow-100 text-yellow-700',
        Low: 'bg-emerald-100 text-emerald-700'
      };
      return `<span class="text-[11px] px-1.5 py-0.5 rounded ${map[s]}">${s}</span>`;
    }

    function markAlert(id) {
      const idx = alertStore.findIndex(a => a.id === id);
      if (idx > -1) {
        alertStore.splice(idx, 1);
        renderAlerts();
        toast('Alert marked as read');
      }
    }

    function filterAlerts() {
      const sev = document.getElementById('alertSeverity').value;
      const agent = document.getElementById('alertAgent').value;
      const filtered = alertStore.filter(a => (!sev || a.sev === sev) && (!agent || a.agent === agent));
      const list = document.getElementById('alertList');
      list.innerHTML = '';
      const groups = {};
      filtered.forEach(a => (groups[a.agent] = groups[a.agent] || []).push(a));
      Object.keys(groups).forEach(agent => {
        const box = document.createElement('div');
        box.className = 'p-4 rounded-xl border border-steel-100 dark:border-steel-700 bg-white/70 dark:bg-steel-900/30';
        box.innerHTML = `
          <div class="flex items-center justify-between mb-3">
            <div class="font-medium">${agent} Agent</div>
            <div class="text-xs text-steel-500">${groups[agent].length} alerts</div>
          </div>
          <div class="space-y-2">
            ${groups[agent].map(a=>`
              <div class="p-3 rounded-lg border border-steel-100 dark:border-steel-700 bg-white/60 dark:bg-steel-900/40 flex items-center justify-between">
                <div class="text-sm">${a.text}</div>
                <div class="flex items-center gap-2">
                  ${sevTag(a.sev)}
                  <span class="text-xs text-steel-500">${a.time}</span>
                  <button class="px-2 py-1 rounded-lg border border-steel-200 dark:border-steel-700 text-xs" onclick="markAlert(${a.id})">Mark read</button>
                </div>
              </div>
            `).join('')}
          </div>
        `;
        list.appendChild(box);
      });
    }
    // VENDORS
    // ----------------------------
    // Simple in-memory data store
    // ----------------------------
    // =================================================================================
    // === 1. GLOBAL STATE AND API CONFIGURATION
    // =================================================================================
    const API_BASE_URL = 'http://127.0.0.1:8000';

    const appState = {
      role: 'User', // The default role when the page loads
      isLoading: true, // Used to show a 'Loading...' message while fetching data

      // --- User-specific state ---
      user: {
        requests: [],
        conversation: {
            state: null,
            messages: [],
            isComplete: false,
            requirementId: null  // ← ADD THIS LINE
    },
    pendingReviewRequest: null
    },
    admin: {
        newRequests: [],
        allRequests: [],
        templates: [],
        activeRequirement: null,
        activeRequirementStep: 'Validate',
        vendorSearchResults: [],
        selectedVendors: new Set(),
        quotes: [],
        searchedVendors: []  // ← ADD THIS LINE
    },

      // --- Vendor-specific state ---
      vendor: {
        // In a real app, this would be determined by login.
        // We'll allow switching for the demo.
        activeVendorId: 1,
        invitations: [],
         allVendors: [
            { id: 1, name: "Sonic Rentals" },
            { id: 2, name: "TechSupply Co" },
            { id: 3, name: "Global Vendors Inc" }
        ]
      },
      vendors: [],  // List of all vendors
      feedbackDraft: { requestId: null, rating: 0 }
    };

    // =================================================================================
    // === 2. API HELPER FUNCTION
    // =================================================================================
  async function apiCall(endpoint, method = "GET", body = null) {
    const options = {
        method,
        headers: { "Content-Type": "application/json" }
    };
    
    if (body) {
        options.body = JSON.stringify(body);
    }
    
    try {
        // Add the forward slash here:
        const response = await fetch(`${API_BASE_URL}${endpoint}`, options);
        //                                          ^ Add this slash
        
        if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.detail || `API Error ${response.status}`);
        }
        
        if (response.status === 204 || response.headers.get('content-length') === '0') {
            return null;
        }
        
        return await response.json();
    } catch (error) {
        console.error(`API call failed for ${method} ${endpoint}:`, error);
        toast(error.message, "error");
        throw error;
    }
}


    // Utility to make unique IDs
    const uid = (p = 'id') => `${p}-${Math.random().toString(36).slice(2,9)}`;

    // ----------------------------
    // AI-like helpers (simple demo)
    // ----------------------------
    function aiSuggestfinalized_items(text) {
      const t = (text || '').toLowerCase();
      let suggestions = [];
      if (t.includes('music') || t.includes('sound') || t.includes('audio')) {
        suggestions.push('Wireless Microphones', 'DJ Controller', 'PA Speakers', 'Audio Mixer', 'XLR Cables', 'On-site Technician');
      }
      if (t.includes('event')) {
        suggestions.push('Delivery & Setup', 'Power Extension Cords', 'Event Coordinator');
      }
      if (t.includes('lighting')) {
        suggestions.push('Stage Lights', 'Light Controller');
      }
      if (suggestions.length === 0) {
        suggestions = ['Delivery & Setup', 'Vendor Coordination'];
      }
      return [...new Set(suggestions)];
    }

    function computeQuoteScores(request) {
      const vendorsById = Object.fromEntries(appState.vendors.map(v => [v.id, v]));
      const finalized_items = request.finalized_items || [];
      const maxRevenue = Math.max(...appState.vendors.map(v => v.revenue));
      (request.quotes || []).forEach(q => {
        const vendor = vendorsById[q.vendorId];
        const matched = q.finalized_itemsCovered ? Math.min(q.finalized_itemsCovered, finalized_items.length) : Math.floor(finalized_items.length * 0.7);
        const relevance = finalized_items.length > 0 ? Math.round((matched / finalized_items.length) * 100) : 60;
        const profile = vendor.profile;
        const revenueScore = Math.round((vendor.revenue / maxRevenue) * 100);
        const score = Math.round(relevance * 0.5 + profile * 0.3 + revenueScore * 0.2);
        q.scores = {
          relevance,
          profile,
          revenue: revenueScore,
          total: score
        };
      });
      request.quotes.sort((a, b) => (b.scores?.total || 0) - (a.scores?.total || 0));
    }

    function recomputeVendorRating(vendor) {
      const reviews = vendor.reviews || [];
      if (!reviews.length) return;
      const avg = reviews.reduce((s, r) => s + (r.rating || 0), 0) / reviews.length;
      vendor.rating = Math.round(avg * 10) / 10;
    }

    function lastFeedbackSnippet(vendor) {
      const r = vendor.reviews?.[vendor.reviews.length - 1];
      return r?.comment || '';
    }

    function extractTagsFromRequest(r) {
      const tags = new Set();
      const txt = (r.text || '').toLowerCase() + ' ' + (r.finalized_items || []).join(' ').toLowerCase();
      if (/(music|audio|sound|speaker|microphone|mixer)/.test(txt)) tags.add('audio');
      if (/(event|venue|stage)/.test(txt)) tags.add('events');
      if (/(light|lighting)/.test(txt)) tags.add('lighting');
      if (/(it|tech|network)/.test(txt)) tags.add('it');
      return Array.from(tags);
    }

    // Render helpers
    function renderStars(rating, size = 'text-sm') {
      const full = Math.floor(rating || 0);
      let out = '';
      for (let i = 1; i <= 5; i++) {
        out += `<span class="${size} ${i <= full ? 'text-amber-500' : 'text-slate-300'}">${i <= full ? '★' : '☆'}</span>`;
      }
      return out;
    }

    // ----------------------------
    // Rendering core
    // ----------------------------
    document.addEventListener('DOMContentLoaded', () => setRole('User'));

async function setRole(role) {
    console.log('🔄 Switching to role:', role);
    
    // Clear any active conversation or detail view when switching roles
    appState.user.conversation = {
        state: null,
        messages: [],
        isComplete: false
    };
    appState.admin.activeRequirement = null;

    appState.role = role;
    appState.isLoading = true;
    render(); // Show loading state immediately
    
    // Fetch data for the role
    await fetchDataForRole(role);
    
    // Load vendor-specific data when switching to vendor role
    // Check both lowercase and the actual button value
    if (role === "vendor" || role === "Vendor") {
        console.log("📞 Calling loadVendorPortalData...");
        await loadVendorPortalData();
        console.log("✅ loadVendorPortalData completed");
    }
    
    appState.isLoading = false;
    render();
    
    console.log('✅ Role switch complete');
}


    async function fetchDataForRole(role) {
      try {
        switch (role) {
          case 'User':
            const userRequests = await apiCall('/requirements');
            appState.user.requests = userRequests;
            if (userRequests.length > 0) {
              const fullUserRequests = await Promise.all(userRequests.map(r => apiCall(`/requirements/${r.id}`)));
              appState.user.pendingReviewRequest = fullUserRequests.find(r => r.status === 'SentForUserConfirmation') || null;
            } else {
              appState.user.pendingReviewRequest = null;
            }
            break;
          case 'Admin':
            [appState.admin.newRequests, appState.admin.allRequests, appState.admin.templates] = await Promise.all([
              apiCall('/requirements/new'),
              apiCall('/requirements'),
              apiCall('/requirements/templates')
            ]);
            break;
          case 'Vendor':
              // Use existing vendor ID (changed via dropdown in UI)
              appState.vendor.invitations = await apiCall(`/rfqs/invitations/${appState.vendor.activeVendorId}`);
              break;

        }
      } catch (error) {
        console.error(`Failed to fetch data for role ${role}:`, error);
      }
    }

    function badge(text, color = 'brand') {
      return `<span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-${color}-100 text-${color}-800 border border-${color}-200">${text}</span>`;
    }

    function statusBadge(status) {
      const map = {
        'Submitted': 'sky',
        'InReview': 'violet',
        'SentForUserConfirmation': 'amber',
        'UserConfirmed': 'emerald',
        'RFQSent': 'indigo',
        'QuotesReceived': 'cyan',
        'Shortlisted': 'purple',
        'WinnerSelected': 'pink',
        'ContractSent': 'pink',
        'Closed': 'slate'
      };
      const color = map[status] || 'slate';
      return `<span class="inline-flex items-center gap-1 px-2 py-0.5 rounded-full text-xs font-medium bg-${color}-100 text-${color}-800 border border-${color}-200"><span class="h-1.5 w-1.5 rounded-full bg-${color}-500"></span>${status}</span>`;
    }

    function currency(n) {
      return new Intl.NumberFormat('en-US', {
        style: 'currency',
        currency: 'USD',
        maximumFractionDigits: 0
      }).format(n || 0);
    }
    // ----------------------------
    // User Role View
    // ----------------------------
    function renderUser() {
      const reqsToShow = appState.user.requests.filter(r => r.status !== 'SentForUserConfirmation');
      return `
        <section class="grid grid-cols-1 lg:grid-cols-3 gap-6">
          <div class="lg:col-span-2 space-y-6">
            ${appState.user.pendingReviewRequest 
              ? renderUserReview(appState.user.pendingReviewRequest) 
              : renderUserSubmitContainer()
            }
            ${renderUserRequestsList(reqsToShow)}
          </div>
          <aside class="space-y-6">${renderHowItWorksPanel()}${renderQuickTipPanel()}</aside>
        </section>
      `;
    }

    function renderHowItWorksPanel() {
      return `<div class="bg-white/80 dark:bg-steel-800 backdrop-blur rounded-2xl border border-steel-200 dark:border-steel-700 shadow-lg p-5"><h3 class="font-semibold mb-2">How this works</h3><ol class="text-sm text-slate-600 dark:text-slate-300 space-y-2 list-decimal list-inside"><li>Describe your requirement.</li><li>Agent asks clarifying questions.</li><li>Confirm the final list from the admin.</li><li>Admin finds vendors and handles contracts.</li><li>You rate the service after delivery.</li></ol></div>`;
    }

    function renderQuickTipPanel() {
      return `<div class="bg-gradient-to-br from-brand-100 to-accent-100 dark:from-brand-900/50 dark:to-accent-900/50 rounded-2xl border border-white/50 dark:border-steel-700 shadow-lg p-5"><h3 class="font-semibold text-slate-900 dark:text-white mb-2">Quick tip</h3><p class="text-sm text-slate-700 dark:text-slate-300">Try being specific (e.g., "a laptop under $1000 for video editing") to get faster results from the agent.</p></div>`;
    }

    function renderAdminDashboard() {
      return `
        <section class="grid grid-cols-1 lg:grid-cols-3 gap-6">
          <div class="lg:col-span-2 space-y-6">
            <div class="bg-white/80 dark:bg-steel-800 backdrop-blur rounded-2xl border border-steel-200 dark:border-steel-700 shadow-lg p-5">
              <div class="flex items-center justify-between mb-3"><h3 class="font-semibold">New Requests</h3><span class="text-xs text-slate-500 dark:text-slate-400">${appState.admin.newRequests.length} waiting</span></div>
              <div class="divide-y divide-slate-100 dark:divide-steel-700">
                ${appState.admin.newRequests.length === 0 ? `<div class="py-10 text-center text-slate-500 dark:text-slate-400">No new requests.</div>` : 
                  appState.admin.newRequests.map(r => `
                    <div class="py-3 flex items-center justify-between gap-3">
                      <div class="min-w-0"><div class="font-medium truncate">${r.title}</div><div class="text-xs text-slate-500 dark:text-slate-400 truncate">${r.initial_query}</div></div>
                      <div class="flex items-center gap-2">${statusBadge(r.status)}<button onclick="selectAdminRequest(${r.id})" class="rounded-lg bg-brand-600 hover:bg-brand-700 text-white px-3 py-1.5 text-sm">Open</button></div>
                    </div>
                  `).join('')
                }
              </div>
            </div>
            <div class="bg-white/80 dark:bg-steel-800 backdrop-blur rounded-2xl border border-steel-200 dark:border-steel-700 shadow-lg p-5">
              <div class="flex items-center justify-between mb-3"><h3 class="font-semibold">All Requests</h3><span class="text-xs text-slate-500 dark:text-slate-400">${appState.admin.allRequests.length} total</span></div>
              <div class="grid md:grid-cols-2 gap-3">
                ${appState.admin.allRequests.map(r => `
                  <div class="rounded-xl border border-slate-100 dark:border-steel-700 bg-white dark:bg-steel-800 p-3 flex flex-col">
                    <div class="flex items-center justify-between"><div class="font-medium truncate pr-2">${r.title}</div>${statusBadge(r.status)}</div>
                    <div class="text-xs text-slate-500 dark:text-slate-400 mt-1 h-8 line-clamp-2">${r.initial_query}</div>
                    <div class="mt-auto pt-2"><button onclick="selectAdminRequest(${r.id})" class="text-brand-600 hover:text-brand-700 text-sm font-medium">Manage</button></div>
                  </div>
                `).join('')}
              </div>
            </div>
          </div>
          <aside class="space-y-6">
            <div class="bg-white/80 dark:bg-steel-800 backdrop-blur rounded-2xl border border-steel-200 dark:border-steel-700 shadow-lg p-5">
              <h3 class="font-semibold mb-2">Requirement History</h3>
              <div class="space-y-3 max-h-96 overflow-auto">
                ${(appState.admin.templates || []).map(t => `
                  <div class="rounded-xl border border-slate-100 dark:border-steel-700 bg-slate-50 dark:bg-steel-700/50 p-3">
                    <div class="text-sm font-medium">${t.title}</div>
                    <div class="text-xs text-slate-600 dark:text-slate-300 line-clamp-2">${t.initial_query}</div>
                    <div class="mt-2"><button onclick="handleReuseTemplate(${t.id})" class="rounded-lg bg-slate-900 dark:bg-slate-600 text-white px-3 py-1.5 text-xs">Reuse</button></div>
                  </div>
                `).join('')}
              </div>
            </div>
            <div class="bg-gradient-to-br from-accent-100 to-brand-100 dark:from-accent-900/50 dark:to-brand-900/50 rounded-2xl border border-white/50 dark:border-steel-700 shadow-lg p-5">
              <h3 class="font-semibold text-slate-900 dark:text-white mb-2">Shortcuts</h3>
              <div class="flex flex-wrap gap-2">
                <button onclick="handleCreateBlankRequest()" class="rounded-lg bg-white/70 dark:bg-steel-700 text-slate-900 dark:text-white border border-slate-200 dark:border-steel-600 px-3 py-1.5 text-xs">New blank request</button>
              </div>
            </div>
          </aside>
        </section>
      `;
    }

    async function selectAdminRequest(reqId) {
      try {
        appState.admin.activeRequirement = await apiCall(`/requirements/${reqId}`);
        const status = appState.admin.activeRequirement.status;
        const statusSequence = {
          'Submitted': 'Validate',
          'InReview': 'Validate',
          'SentForUserConfirmation': 'Validate',
          'UserConfirmed': 'Vendors',
          'RFQSent': 'Quotes',
          'QuotesReceived': 'Quotes',
          'Shortlisted': 'Quotes',
          'WinnerSelected': 'Contract',
          'ContractSent': 'Contract',
          'Closed': 'Contract'
        };
        appState.admin.activeRequirementStep = statusSequence[status] || 'Validate';
        if (appState.admin.activeRequirementStep === 'Quotes') {
          await handleFetchQuotes(reqId); // Pre-fetch quotes if we're on this step
        }
        render();
      } catch (error) {}
    }

    function renderUserRequestsList(requests) {
      return `
        <div class="bg-white/80 dark:bg-steel-800 backdrop-blur rounded-2xl border border-steel-200 dark:border-steel-700 shadow-lg p-5">
          <div class="flex items-center justify-between mb-3"><h3 class="font-semibold">My Requests</h3><span class="text-xs text-slate-500 dark:text-slate-400">${requests.length} total</span></div>
          <div class="divide-y divide-slate-100 dark:divide-steel-700">
            ${requests.length === 0 ? `<div class="py-8 text-center text-slate-500 dark:text-slate-400">No active requests.</div>` : 
              requests.map(r => `
                <div class="py-3 flex items-center justify-between gap-3">
                  <div class="min-w-0"><div class="font-medium truncate">${r.title || 'Requirement'}</div><div class="text-xs text-slate-500 dark:text-slate-400 truncate">${r.initial_query}</div></div>
                  <div class="flex items-center gap-2">${statusBadge(r.status)}<button onclick="viewRequestDetails(${r.id})" class="text-brand-600 hover:text-brand-700 text-sm font-medium">View</button></div>
                </div>
              `).join('')
            }
          </div>
        </div>
      `;
    }

    async function viewRequestDetails(reqId) {
      try {
        const req = await apiCall(`/requirements/${reqId}`);
        // A simple alert, can be replaced with a modal
        alert(`Status: ${req.status}\nTitle: ${req.title}\nInitial Query: ${req.initial_query}`);
      } catch (e) {}
    }

    function renderUserSubmitContainer() {
      return (appState.user.conversation.messages.length > 0) ? renderUserConversation() : renderUserSubmitForm();
    }

    function renderUserConversation() {
      return `
        <div class="bg-white/80 dark:bg-steel-800 backdrop-blur rounded-2xl border border-steel-200 dark:border-steel-700 shadow-lg p-6">
          <h2 class="text-lg font-semibold mb-4">Finalizing Your Requirement</h2>
          <div id="chat-messages" class="space-y-4 mb-4 max-h-96 overflow-y-auto pr-2">
            ${appState.user.conversation.messages.map(msg => `
              <div class="flex ${msg.type === 'human' ? 'justify-end' : 'justify-start'}">
                <div class="max-w-md p-3 rounded-lg ${msg.type === 'human' ? 'bg-brand-600 text-white' : 'bg-steel-100 dark:bg-steel-700'}">
                  ${msg.content.replace(/\n/g, '<br>')}
                </div>
              </div>
            `).join('')}
          </div>
          ${!appState.user.conversation.isComplete ? `
            <form onsubmit="handleUserConversationTurn(event)" class="flex items-center gap-2">
              <input id="user-chat-input" type="text" placeholder="Type your answer..." required class="w-full rounded-xl border border-steel-200 dark:border-steel-600 bg-white/50 dark:bg-steel-700 px-3 py-2 focus:ring-2 focus:ring-brand-400 outline-none" autocomplete="off" autofocus>
              <button type="submit" class="rounded-xl bg-brand-600 hover:bg-brand-700 text-white px-4 py-2.5">Send</button>
            </form>
          ` : ''}
        </div>
      `;
    }

    function renderUserSubmitForm() {
      return `
        <div class="bg-white/80 dark:bg-steel-800 backdrop-blur rounded-2xl border border-steel-200 dark:border-steel-700 shadow-lg p-6">
          <h2 class="text-lg font-semibold mb-4">Submit a Requirement</h2>
          <form onsubmit="handleUserSubmit(event)" class="space-y-4">
            <div>
              <label class="block text-sm font-medium mb-1">Requirement details</label>
              <textarea id="user-initial-query" required rows="4" placeholder="e.g. I need a music system for an event on 22nd August" class="w-full rounded-xl border border-steel-200 dark:border-steel-600 bg-white/50 dark:bg-steel-700 px-3 py-2 focus:ring-2 focus:ring-brand-400 outline-none"></textarea>
            </div>
            <div class="flex items-center gap-3 pt-2">
              <button type="submit" class="inline-flex items-center gap-2 rounded-xl bg-brand-600 hover:bg-brand-700 text-white px-4 py-2.5 shadow-soft">Submit</button>
            </div>
          </form>
        </div>
      `;
    }

    function renderUserFeedbackBlocks() {
      // Show a prompt block if any request is closed and needs feedback
      const needFb = appState.user.requests.find(r => r.status === 'Closed' && !r.feedback && !r.isTemplate);
      if (!needFb) return '';
      return `
        <div class="bg-emerald-50 border border-emerald-200 rounded-2xl p-4">
          <div class="flex items-center justify-between">
            <div>
              <div class="font-medium text-emerald-900">Service delivered</div>
              <div class="text-sm text-emerald-700">Please rate your experience for "${needFb.title || 'Requirement'}".</div>
            </div>
            <button onclick="openFeedback('${needFb.id}')" class="rounded-lg bg-emerald-600 hover:bg-emerald-700 text-white px-4 py-2 text-sm">Give Feedback</button>
          </div>
        </div>
      `;
    }

    function renderUserSubmit() {
      return `
        <div class="bg-white/80 backdrop-blur rounded-2xl border border-white shadow-soft p-6">
          <div class="flex items-center justify-between mb-4">
            <h2 class="text-lg font-semibold text-slate-900">Submit a Requirement</h2>
          </div>
          <form onsubmit="handleUserSubmit(event)" class="space-y-4">
            <div>
              <label class="block text-sm font-medium text-slate-700 mb-1">Requirement details</label>
              <textarea id="u_text" required rows="4" placeholder="e.g. I need a music system for an event on 22nd August" class="w-full rounded-xl border border-slate-200 bg-white px-3 py-2 focus:ring-2 focus:ring-brand-400 outline-none"></textarea>
            </div>
            <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
              <div class="sm:col-span-2">
                <label class="block text-sm font-medium text-slate-700 mb-1">Event date (optional)</label>
                <input id="u_date" type="date" class="w-full rounded-xl border border-slate-200 bg-white px-3 py-2 focus:ring-2 focus:ring-brand-400 outline-none" />
              </div>
              <div>
                <label class="block text-sm font-medium text-slate-700 mb-1">Attach documents</label>
                <input id="u_files" type="file" multiple class="w-full rounded-xl border border-slate-200 bg-white px-3 py-2 focus:ring-2 focus:ring-brand-400 outline-none" />
              </div>
            </div>
            <div id="u_filelist" class="flex flex-wrap gap-2 text-xs"></div>
            <div class="flex items-center gap-3 pt-2">
              <button class="inline-flex items-center gap-2 rounded-xl bg-brand-600 hover:bg-brand-700 text-white px-4 py-2.5 shadow-soft">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 opacity-90" viewBox="0 0 24 24" fill="currentColor">
                  <path d="M12 4a1 1 0 011 1v6h6a1 1 0 110 2h-6v6a1 1 0 11-2 0v-6H5a1 1 0 110-2h6V5a1 1 0 011-1z"/>
                </svg>
                Submit Requirement
              </button>
              <span class="text-sm text-slate-500">You'll get a confirmation after Admin validates it.</span>
            </div>
          </form>
        </div>
      `;
    }

    function renderUserReview(req) {
      return `
        <div class="bg-white/80 dark:bg-steel-800 backdrop-blur rounded-2xl border border-steel-200 dark:border-steel-700 shadow-lg p-6">
          <div class="flex items-center justify-between mb-2"><h2 class="text-lg font-semibold">Review and Confirm</h2>${statusBadge(req.status)}</div>
          <p class="text-sm text-slate-600 dark:text-slate-300 mb-4">Admin finalized these finalized_items. Please confirm or request changes.</p>
          <div class="bg-slate-50 dark:bg-steel-700 border border-slate-200 dark:border-steel-600 rounded-xl p-3 mb-4">
            <div class="text-xs text-slate-500 dark:text-slate-400 mb-1">Original request</div>
            <div class="text-sm">${req.initial_query}</div>
          </div>
          <div class="mb-4">
            <div class="text-sm font-medium mb-2">Finalized finalized_items</div>
            <div class="flex flex-wrap gap-2">
              ${(req.finalized_finalized_items || []).map(item => `<span class="inline-flex items-center gap-1 bg-emerald-50 text-emerald-900 border border-emerald-200 px-2 py-1 rounded-full text-xs">${item}</span>`).join('')}
            </div>
          </div>
          <div class="space-y-3">
            <div><label class="block text-sm font-medium mb-1">Add a comment (optional)</label><input id="user-confirm-comment" type="text" placeholder="Looks good!" class="w-full rounded-xl border-steel-200 dark:border-steel-600 bg-white/50 dark:bg-steel-700 px-3 py-2 focus:ring-2 focus:ring-brand-400 outline-none" /></div>
            <div class="flex flex-wrap items-center gap-3">
              <button onclick="handleUserConfirmation(${req.id}, 'approve')" class="rounded-xl bg-emerald-600 hover:bg-emerald-700 text-white px-4 py-2.5">Approve</button>
              <button onclick="handleUserConfirmation(${req.id}, 'request_changes')" class="rounded-xl bg-amber-500 hover:bg-amber-600 text-white px-4 py-2.5">Request Changes</button>
            </div>
          </div>
        </div>
      `;
    }

    function viewUserRequest(id) {
      const r = appState.user.requests.find(x => x.id === id);
      if (!r) return;
      alert(`Request: ${r.title || 'Requirement'}\nStatus: ${r.status}\n\n${r.text}`);
    }

    async function handleUserSubmit(event) {
      event.preventDefault();
      const userInput = document.getElementById('user-initial-query').value.trim();

      if (!userInput) return;

      try {
        const data = await apiCall('/requirements/converse', 'POST', {
          user_input: userInput
        });
        appState.user.conversation.messages = [{
          type: 'human',
          content: userInput
        }, {
          type: 'ai',
          content: data.response
        }];
        appState.user.conversation.state = data.state;
        appState.user.conversation.isComplete = data.is_complete; // FIXED
        appState.user.conversation.requirementId = data.requirement_id || null; // ADD
        render();
      } catch (e) {
        toast('Failed to start conversation', 'error');
      }
    }

    async function handleValidateWithAI(reqId) {
      if (!reqId) return;
      try {
        appState.isLoading = true;
        render();

        const data = await apiCall(`/requirements/${reqId}/validate`, 'POST', {});

        // Update the active requirement with AI suggestions
        appState.admin.activeRequirement.ai_suggestions = data.ai_suggestions;

        toast('AI validation complete!');
        appState.isLoading = false;
        render();
      } catch (error) {
        toast('AI validation failed', 'error');
        appState.isLoading = false;
        render();
      }
    }

async function handleSearchVendors(reqId) {
    if (!reqId) return;
    
    try {
        appState.isLoading = true;
        render();
        
        const data = await apiCall(`/requirements/${reqId}/search-vendors`, 'POST');
        
        // Store vendors
        if (Array.isArray(data)) {
            appState.admin.searchedVendors = data;
        } else {
            appState.admin.searchedVendors = data.vendors || [];
        }
        
        toast(`✓ Found ${appState.admin.searchedVendors.length} potential vendors`);
        
        appState.isLoading = false;
        render();
    } catch (error) {
        console.error('Vendor search failed:', error);
        toast('Vendor search failed', 'error');
        appState.isLoading = false;
        render();
    }
}



    async function handleUserConversationTurn(event) {
        event.preventDefault();
        const input = document.getElementById('user-chat-input');
        const userInput = input.value.trim();
        if (!userInput) return;

        try {
            appState.isLoading = true;
            appState.user.conversation.messages.push({ type: 'human', content: userInput });
            input.value = '';
            render();

            const data = await apiCall('/requirements/converse', 'POST', {
                user_input: userInput,
                state: appState.user.conversation.state
            });

            appState.user.conversation.messages.push({ type: 'ai', content: data.response });
            appState.user.conversation.state = data.state;
            appState.user.conversation.isComplete = data.is_complete;  // FIXED: underscore notation
            appState.user.conversation.requirementId = data.requirement_id;

            if (data.is_complete && data.requirement_id) {
                toast(`✓ Requirement #${data.requirement_id} submitted successfully!`);
                // Refresh the user requests list
                setTimeout(async () => {
                    await fetchDataForRole('User');
                }, 1000);

            }

            appState.isLoading = false;
            render();
        } catch(e) {
            toast('Failed to send message', 'error');
            appState.isLoading = false;
            render();
        }
    }

    async function handleUserConfirmation(reqId, action) {
      const comment = document.getElementById('user-confirm-comment').value;
      if (action === 'request_changes' && !comment) return toast('A comment is required when requesting changes.', 'error');
      try {
        await apiCall(`/requirements/${reqId}/confirm`, 'POST', {
          action,
          comment
        });
        toast(action === 'approve' ? 'Requirement approved!' : 'Change request sent.');
        appState.user.pendingReviewRequest = null;
        await fetchDataForRole('User');
        render();
      } catch (error) {}
    }

    function userRequestChanges(id) {
      const r = appState.user.requests.find(x => x.id === id);
      if (!r) return;
      const extra = prompt('Describe the change you want:');
      if (extra && extra.trim()) {
        r.text += `\n\nUser note: ${extra.trim()}`;
        r.status = 'Submitted';
        r.finalized_items = [];
        r.suggestions = [];
        toast('Change request sent back to Admin.');
        render();
      }
    }

    // Track chosen file names in user submit view
    document.addEventListener('change', (e) => {
      if (e.target && e.target.id === 'u_files') {
        const list = Array.from(e.target.files || []);
        document.getElementById('u_filelist').innerHTML = list.map(f =>
          `<span class="inline-flex items-center gap-1 bg-slate-100 text-slate-700 border border-slate-200 px-2 py-1 rounded-full">${f.name}</span>`
        ).join('');
      }
    });

    // ----------------------------
    // Admin Role View
    // ----------------------------
    function renderAdmin() {
      const newRequests = appState.user.requests.filter(r => !r.isTemplate && (r.status === 'Submitted' || r.status === 'InReview'));
      const allRequests = appState.user.requests.filter(r => !r.isTemplate).sort((a, b) => b.createdAt - a.createdAt);
      const templates = appState.user.requests.filter(r => r.isTemplate);
      const current = appState.user.requests.find(r => r.id === appState.admin.currentRequestId);

      return `
        <section class="grid grid-cols-1 lg:grid-cols-3 gap-6">
          <div class="lg:col-span-2 space-y-6">
            ${current ? renderAdminRequestDetail(current) : `
              <div class="bg-white/80 backdrop-blur rounded-2xl border border-white shadow-soft p-5">
                <div class="flex items-center justify-between mb-3">
                  <h3 class="font-semibold text-slate-900">New Requests</h3>
                  <span class="text-xs text-slate-500">${newRequests.length} waiting</span>
                </div>
                <div class="divide-y divide-slate-100">
                  ${newRequests.length === 0 ? `<div class="py-10 text-center text-slate-500">No new requests right now.</div>` :
                    newRequests.map(r => `
                      <div class="py-3 flex items-center justify-between gap-3">
                        <div class="min-w-0">
                          <div class="font-medium text-slate-900 truncate">${r.title || 'Requirement'}</div>
                          <div class="text-xs text-slate-500 truncate">${r.text}</div>
                        </div>
                        <div class="flex items-center gap-2">
                          ${statusBadge(r.status)}
                          <button onclick="selectAdminRequest('${r.id}')" class="rounded-lg bg-brand-600 hover:bg-brand-700 text-white px-3 py-1.5 text-sm">Open</button>
                        </div>
                      </div>
                    `).join('')
                  }
                </div>
              </div>
              <div class="bg-white/80 backdrop-blur rounded-2xl border border-white shadow-soft p-5">
                <div class="flex items-center justify-between mb-3">
                  <h3 class="font-semibold text-slate-900">All Requests</h3>
                  <span class="text-xs text-slate-500">${allRequests.length} total</span>
                </div>
                <div class="grid md:grid-cols-2 gap-3">
                  ${allRequests.map(r => `
                    <div class="rounded-xl border border-slate-100 bg-white p-3 flex flex-col">
                      <div class="flex items-center justify-between">
                        <div class="font-medium text-slate-900 truncate pr-2">${r.title || 'Requirement'}</div>
                        ${statusBadge(r.status)}
                      </div>
                      <div class="text-xs text-slate-500 mt-1 line-clamp-2">${r.text}</div>
                      <div class="mt-3">
                        <button onclick="selectAdminRequest('${r.id}')" class="text-brand-600 hover:text-brand-700 text-sm font-medium">Manage</button>
                      </div>
                    </div>
                  `).join('')}
                </div>
              </div>
            `}
          </div>
          <aside class="space-y-6">
            <div class="bg-white/80 backdrop-blur rounded-2xl border border-white shadow-soft p-5">
              <h3 class="font-semibold text-slate-900 mb-2">Requirement history</h3>
              <div class="space-y-3">
                ${templates.map(t => `
                  <div class="rounded-xl border border-slate-100 bg-slate-50 p-3">
                    <div class="text-sm font-medium text-slate-900">${t.title}</div>
                    <div class="text-xs text-slate-600 line-clamp-2">${t.text}</div>
                    <div class="mt-2 flex flex-wrap gap-1">
                      ${t.finalized_items.map(i => `<span class="bg-white border border-slate-200 text-slate-700 rounded-full px-2 py-0.5 text-[11px]">${i}</span>`).join('')}
                    </div>
                    <div class="mt-2">
                      <button onclick="reuseTemplate('${t.id}')" class="rounded-lg bg-slate-900 text-white px-3 py-1.5 text-xs">Reuse</button>
                    </div>
                  </div>
                `).join('')}
              </div>
            </div>
            <div class="bg-gradient-to-br from-accent-100 to-brand-100 rounded-2xl border border-white shadow-soft p-5">
              <h3 class="font-semibold text-slate-900 mb-2">Shortcuts</h3>
              <div class="flex flex-wrap gap-2">
                <button onclick="createBlankRequest()" class="rounded-lg bg-white text-slate-900 border border-slate-200 px-3 py-1.5 text-xs">New blank request</button>
                <button onclick="jumpToQuotes()" class="rounded-lg bg-white text-slate-900 border border-slate-200 px-3 py-1.5 text-xs">Quotes view</button>
              </div>
            </div>
          </aside>
        </section>
      `;
    }

    function renderAdminRequestDetail() {
      const req = appState.admin.activeRequirement;
      const step = appState.admin.activeRequirementStep;
      const steps = ['Validate', 'Vendors', 'Quotes', 'Contract'];
      const statusSequence = {
        'Submitted': 0,
        'InReview': 0,
        'SentForUserConfirmation': 0,
        'UserConfirmed': 1,
        'RFQSent': 2,
        'QuotesReceived': 2,
        'Shortlisted': 2,
        'WinnerSelected': 3,
        'ContractSent': 3,
        'Closed': 3
      };
      const currentStatusIndex = statusSequence[req.status] ?? 0;
      let stepContent = '';
      switch (step) {
        case 'Validate':
          stepContent = renderAdminValidate();
          break;
        case 'Vendors':
          stepContent = renderAdminVendors();
          break;
        case 'Quotes':
          stepContent = renderAdminQuotes();
          break;
        case 'Contract':
          stepContent = renderAdminContract();
          break;
        default:
          stepContent = '<div>Error: Unknown Step</div>';
      }
      return `
        <div class="bg-white/80 dark:bg-steel-800 backdrop-blur rounded-2xl border border-steel-200 dark:border-steel-700 shadow-lg p-5">
          <div class="flex items-center justify-between flex-wrap gap-2 mb-3">
            <div>
              <div class="text-xs uppercase tracking-wider text-slate-500 dark:text-slate-400">Managing Request</div>
              <div class="text-lg font-semibold">${req.title}</div>
            </div>
            <div class="flex items-center gap-2">${statusBadge(req.status)}<button class="rounded-lg bg-slate-900 dark:bg-slate-600 text-white px-3 py-1.5 text-sm" onclick="appState.admin.activeRequirement=null; fetchDataForRole('Admin');">Back</button></div>
          </div>
          <div class="flex flex-wrap items-center gap-2 mb-4 border-b border-slate-200 dark:border-steel-700 pb-4">
            ${steps.map((s, i) => {
              const isActive = s === step;
              const isAccessible = i <= currentStatusIndex;
              return `<button ${isAccessible ? '' : 'disabled'} onclick="setAdminStep('${s}')" class="px-3 py-1.5 rounded-full text-sm font-medium border ${isActive ? 'bg-brand-600 text-white border-brand-600' : 'bg-white dark:bg-steel-700 text-slate-700 dark:text-slate-200 border-slate-200 dark:border-steel-600'} ${isAccessible ? 'hover:bg-slate-50 dark:hover:bg-steel-600' : 'opacity-50 cursor-not-allowed'}">${s}</button>`;
            }).join('')}
          </div>
          <div>${stepContent}</div>
        </div>`;
    }

    async function setAdminStep(step) {
      appState.admin.activeRequirementStep = step;
      if (step === 'Quotes' && appState.admin.quotes.length === 0) { // Only fetch if not already fetched
        await handleFetchQuotes(appState.admin.activeRequirement.id);
      }
      render();
    }

    function renderStepLocked(msg) {
      return `
        <div class="rounded-xl border border-slate-200 bg-slate-50 p-6 text-center text-slate-600">
          ${msg}
        </div>
      `;
    }

function renderAdminValidate() {
  const r = appState.admin.activeRequirement;
  if (!r) return '<div>No active requirement</div>';
  
  const suggestions = r.ai_suggestions || r.suggestions || [];
  const finalized_items = r.finalized_items || [];
  const files = r.files || [];
  
  // Check if user has approved
  const isUserApproved = r.status === 'UserConfirmed';
  const isSentForApproval = r.status === 'SentForUserConfirmation' || r.status === 'PendingUserApproval';

  return `
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
      <div class="lg:col-span-2 space-y-4">
        <div class="rounded-xl border border-slate-200 bg-white p-4">
          <div class="text-sm font-medium text-slate-900 mb-2">Original Requirement</div>
          <p class="text-sm text-slate-700 whitespace-pre-line">${r.raw_input || r.initial_query || r.text || 'No description provided'}</p>

          ${files.length ? `
            <div class="mt-3 flex flex-wrap gap-2 text-xs">
              ${files.map(f => `<span class="bg-slate-50 border border-slate-200 text-slate-700 rounded-full px-2 py-0.5">${f.name}</span>`).join('')}
            </div>
          ` : ''}
        </div>

        <div class="rounded-xl border border-slate-200 bg-white p-4">
          <div class="flex items-center justify-between mb-3">
            <div class="text-sm font-medium text-slate-900">Validation</div>
            <button onclick="validateRequirement('${r.id}')" class="inline-flex items-center gap-2 rounded-lg bg-accent-600 hover:bg-accent-700 text-white px-3 py-1.5 text-sm">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 opacity-90" viewBox="0 0 24 24" fill="currentColor"><path d="M11 3a1 1 0 011 1v7h7a1 1 0 110 2h-7v7a1 1 0 11-2 0v-7H3a1 1 0 110-2h7V4a1 1 0 011-1z"/></svg>
              Validate Requirement
            </button>
          </div>

          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div class="rounded-lg border border-slate-200 p-3">
              <div class="text-xs font-medium text-slate-700 mb-2">AI Suggestions</div>
              <div id="sug_${r.id}" class="flex flex-wrap gap-2">
                ${suggestions.length ? suggestions.map(s => `
                  <button onclick="addItem('${r.id}', '${s.replace(/'/g,"&apos;")}')" class="text-xs bg-brand-50 hover:bg-brand-100 border border-brand-200 text-brand-800 rounded-full px-2 py-1">${s}</button>
                `).join('') : `<div class="text-xs text-slate-500">Click "Validate Requirement" to get suggestions</div>`}
              </div>
            </div>
            <div class="rounded-lg border border-slate-200 p-3">
              <div class="text-xs font-medium text-slate-700 mb-2">Finalized Items</div>
              <div id="finalized_items_${r.id}" class="flex flex-wrap gap-2 min-h-[38px]">
                ${finalized_items.length ? finalized_items.map(i => `
                  <span class="inline-flex items-center gap-1 bg-emerald-50 text-emerald-900 border border-emerald-200 px-2 py-1 rounded-full text-xs">
                    ${i}
                    <button title="Remove" onclick="removeItem('${r.id}','${i.replace(/'/g,"&apos;")}')" class="text-emerald-700 hover:text-emerald-900">×</button>
                  </span>
                `).join('') : `<div class="text-xs text-slate-500">No items yet</div>`}
              </div>
              <div class="mt-3 flex gap-2">
                <input id="add_${r.id}" type="text" placeholder="Add custom item" class="flex-1 rounded-lg border border-slate-200 px-3 py-2 text-sm focus:ring-2 focus:ring-brand-400 outline-none">
                <button onclick="addCustomItem('${r.id}')" class="rounded-lg bg-slate-900 text-white px-3 py-2 text-sm">Add</button>
              </div>
            </div>
          </div>

          <!-- Only Validate with AI Button -->
          <div class="mt-6">
            <button 
              onclick="handleValidateWithAI('${r.id}')" 
              class="rounded-lg bg-brand-600 hover:bg-brand-700 text-white px-4 py-2.5 font-medium shadow-sm transition-colors">
              🤖 Validate with AI
            </button>
          </div>

          <!-- Display AI Suggestions if available -->
          ${r.ai_suggestions && r.ai_suggestions.length > 0 ? `
            <div class="mt-4 p-4 rounded-xl bg-green-50 border border-green-200">
              <div class="flex items-center gap-2 mb-3">
                <svg class="h-5 w-5 text-green-600" fill="currentColor" viewBox="0 0 20 20">
                  <path d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z"/>
                  <path fill-rule="evenodd" d="M4 5a2 2 0 012-2 3 3 0 003 3h2a3 3 0 003-3 2 2 0 012 2v11a2 2 0 01-2 2H6a2 2 0 01-2-2V5zm3 4a1 1 0 000 2h.01a1 1 0 100-2H7zm3 0a1 1 0 000 2h3a1 1 0 100-2h-3zm-3 4a1 1 0 100 2h.01a1 1 0 100-2H7zm3 0a1 1 0 100 2h3a1 1 0 100-2h-3z" clip-rule="evenodd"/>
                </svg>
                <span class="font-semibold text-green-900">AI Suggestions</span>
              </div>
              <ul class="text-sm space-y-2 text-green-800">
                ${r.ai_suggestions.map(suggestion => 
                  `<li class="flex items-start gap-2">
                    <span class="text-green-600 mt-0.5">•</span>
                    <span>${suggestion}</span>
                  </li>`
                ).join('')}
              </ul>
            </div>
          ` : ''}

          <!-- Finalize Button -->
          <div class="mt-4 flex flex-wrap items-center gap-2">
            <button 
              onclick="sendToUserConfirmation('${r.id}')" 
              class="rounded-xl bg-emerald-600 hover:bg-emerald-700 text-white px-4 py-2.5 font-medium"
              ${isSentForApproval ? 'disabled' : ''}>
              ${isSentForApproval ? 'Sent to User ✓' : 'Finalize & Send to User'}
            </button>
            <span class="text-sm text-slate-500">User will be prompted to approve.</span>
          </div>
          
          <!-- Approval Status Messages -->
          ${isSentForApproval ? `
            <div class="mt-3 text-sm text-amber-600 flex items-center gap-2">
              <svg class="h-4 w-4 animate-spin" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
              </svg>
              Waiting for user approval...
            </div>
          ` : ''}
          
          ${isUserApproved ? `
            <div class="mt-3 text-sm text-green-600 flex items-center gap-2">
              <svg class="h-4 w-4" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
              </svg>
              User approved! Navigate to Vendors tab to search for vendors.
            </div>
          ` : ''}
        </div>
      </div>

      <div class="space-y-4">
        <div class="rounded-xl border border-slate-200 bg-white p-4">
          <div class="text-sm font-medium text-slate-900 mb-2">Quick Actions</div>
          <div class="flex flex-wrap gap-2">
            <button onclick="quickSelect('${r.id}', ['Wireless Microphones','PA Speakers','Audio Mixer'])" class="rounded-lg bg-white border border-slate-200 px-3 py-1.5 text-sm hover:bg-slate-50">Small audio kit</button>
            <button onclick="quickSelect('${r.id}', ['Stage Lights','Light Controller','Delivery & Setup'])" class="rounded-lg bg-white border border-slate-200 px-3 py-1.5 text-sm hover:bg-slate-50">Add lighting</button>
          </div>
        </div>

        <div class="rounded-xl border border-slate-200 bg-white p-4">
          <div class="text-sm font-medium text-slate-900 mb-2">Progress</div>
          <ul class="text-sm text-slate-600 space-y-2">
            <li>Validation ${finalized_items.length ? badge('Ready','emerald') : badge('Pending','amber')}</li>
            <li>User Confirmation ${isUserApproved ? badge('Approved','emerald') : isSentForApproval ? badge('Waiting','amber') : badge('Not Sent','slate')}</li>
            <li>Vendor Search ${isUserApproved ? badge('Ready','emerald') : badge('Pending','slate')}</li>
            <li>RFQ ${['RFQSent','QuotesReceived','Shortlisted','ContractSent','Closed'].includes(r.status) ? badge('Sent','indigo') : badge('Not sent','slate')}</li>
          </ul>
        </div>
      </div>
    </div>
  `;
}



async function finalizeAndSendToUser(reqId) {
    try {
        const response = await apiCall(`/requirements/${reqId}/finalize`, 'POST');
        
        toast('✓ Sent to user for approval!');
        
        // Update state
        if (appState.admin.activeRequirement && appState.admin.activeRequirement.id === reqId) {
            appState.admin.activeRequirement.status = response.status;
        }
        
        render();
    } catch (error) {
        toast('Failed to finalize', 'error');
    }
}

   function renderAdminVendors() {
    const r = appState.admin.activeRequirement;
    if (!r) return '<div>No active requirement</div>';
    
    const selected = new Set(r.vendorsSelected || []);
    const anySelected = selected.size > 0;
    
    // ✅ Read from appState.admin.searchedVendors instead of r.filteredVendors
    const vendorList = appState.admin.searchedVendors || [];
    const hasSearched = vendorList.length > 0;

    return `
        <div class="space-y-4">
          <!-- Search Section -->
          <div class="rounded-2xl border border-slate-200 bg-white p-4">
            <div class="flex items-center justify-between">
              <div>
                <div class="text-sm font-medium text-slate-900">Search Vendors</div>
                <p class="text-sm text-slate-600 mt-1">Run a quick search to populate the vendor list based on the requirement.</p>
              </div>
              <button onclick="handleSearchVendors('${r.id}')" 
                      class="rounded-lg bg-slate-900 hover:bg-slate-800 text-white px-4 py-2.5 font-medium">
                Search Vendors
              </button>
            </div>
          </div>

          <!-- Vendor Directory -->
          <div class="rounded-2xl border border-slate-200 bg-white p-4">
            <div class="flex items-center justify-between mb-3">
              <div class="text-sm font-medium text-slate-900">Vendor Directory</div>
              <div class="text-xs text-slate-500">${vendorList.length} found</div>
            </div>
            
            ${!hasSearched ? `
              <div class="text-center text-slate-500 py-12">
                Click "Search Vendors" to populate the list.
              </div>
            ` : `
              <div class="space-y-3">
                ${vendorList.map(v => `
                  <label class="rounded-xl border ${selected.has(v.id) ? 'border-brand-500 bg-brand-50' : 'border-slate-200'} p-4 flex gap-3 items-start cursor-pointer hover:border-brand-300 transition-colors">
                    <input type="checkbox" 
                           ${selected.has(v.id) ? 'checked' : ''} 
                           onchange="toggleVendorSelect('${r.id}', '${v.id}', this.checked)" 
                           class="mt-1 rounded border-slate-300 text-brand-600 focus:ring-brand-500">
                    <div class="min-w-0 flex-1">
                      <div class="flex items-center gap-2">
                        <span class="text-brand-600">📍</span>
                        <div class="font-medium text-slate-900">${v.name}</div>
                      </div>
                      ${v.url ? `
                        <a href="${v.url}" target="_blank" 
                           class="text-xs text-brand-600 hover:underline mt-1 inline-block">
                            ${v.url}
                        </a>
                      ` : ''}
                      <div class="flex gap-4 mt-2 text-xs text-slate-600">
                        <span>Revenue: ₹${(v.revenue || 0).toLocaleString()}</span>
                        <span>Rating: ${v.rating || 'N/A'} ⭐</span>
                        ${v.profile ? `<span>Profile: ${v.profile}%</span>` : ''}
                      </div>
                      ${v.reviews && v.reviews.length > 0 ? `
                        <div class="mt-2 space-y-1">
                          <div class="text-xs font-medium text-slate-700">Recent feedback:</div>
                          ${v.reviews.slice(0, 2).map(review => `
                            <div class="text-xs bg-slate-50 border border-slate-200 rounded-lg px-2 py-1">
                              <div class="flex items-center gap-1 mb-0.5">
                                <span class="text-amber-500">⭐ ${review.rating}</span>
                              </div>
                              <div class="text-slate-600 line-clamp-2">"${review.comment}"</div>
                            </div>
                          `).join('')}
                        </div>
                      ` : ''}
                    </div>
                  </label>
                `).join('')}
              </div>
              
              <!-- Request Quotes Button -->
              <div class="mt-4 flex items-center gap-3">
                <button 
                  ${anySelected ? '' : 'disabled'} 
                  onclick="sendRFQ('${r.id}')" 
                  class="rounded-xl ${anySelected ? 'bg-indigo-600 hover:bg-indigo-700' : 'bg-slate-300 cursor-not-allowed'} text-white px-4 py-2.5 font-medium">
                  Request Quotes
                </button>
                <span class="text-sm text-slate-500">Selected ${selected.size} vendor(s)</span>
              </div>
            `}
          </div>

          <!-- Questionnaire -->
          <div class="rounded-2xl border border-slate-200 bg-white p-4">
            <div class="text-sm font-medium text-slate-900 mb-2">Questionnaire</div>
            <div class="text-sm text-slate-600 mb-3">These questions will be sent with your RFQ.</div>
            <div id="q_list_${r.id}" class="flex flex-wrap gap-2 mb-3">
              ${(r.questionnaires || []).map(q => `
                <span class="inline-flex items-center gap-1 bg-slate-50 text-slate-800 border border-slate-200 px-2 py-1 rounded-full text-xs">${q}</span>
              `).join('')}
            </div>
            <div class="text-xs text-slate-500">Note: Auto-filled with your mandatory 4 questions when you click "Request Quotes".</div>
          </div>

          <!-- Next Step -->
          <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <div class="lg:col-span-2"></div>
            <div class="space-y-4">
              <div class="rounded-xl border border-slate-200 bg-white p-4">
                <div class="text-sm font-medium text-slate-900 mb-2">Next</div>
                <p class="text-sm text-slate-600">Once quotes arrive, go to Quotes to compare and shortlist.</p>
                <div class="mt-2">
                  <button onclick="setAdminStep('Quotes')" class="rounded-lg bg-white border border-slate-200 px-3 py-1.5 text-sm hover:bg-slate-50">Open Quotes</button>
                </div>
              </div>
            </div>
          </div>
        </div>
    `;
}


    function renderAdminEvidence() {
      const r = appState.admin.activeRequirement;
      const entries = [];
      (r.quotes || []).forEach(q => {
        (q.evidence || []).forEach(f => {
          const v = appState.vendors.find(v => v.id === q.vendorId);
          entries.push({
            vendor: v?.name || q.vendorId,
            name: f.name
          });
        });
      });
      if (!entries.length) {
        return `<div class="text-xs text-slate-500">No evidence uploaded yet.</div>`;
      }
      return entries.map(e => `
        <div class="text-xs bg-slate-50 border border-slate-200 rounded-lg px-2 py-1 flex items-center justify-between">
          <span class="truncate pr-2">${e.name}</span>
          <span class="text-slate-500">by ${e.vendor}</span>
        </div>
      `).join('');
    }

    function renderAdminQuotes() {
      const r = appState.admin.activeRequirement;
      const quotes = r.quotes || [];
      return `
        <div class="space-y-4">
          <div class="rounded-xl border border-slate-200 bg-white p-4">
            <div class="flex items-center justify-between">
              <div>
                <div class="text-sm font-medium text-slate-900">Quotes</div>
                <div class="text-xs text-slate-600">Compare, score, and shortlist vendors.</div>
              </div>
              <div class="flex items-center gap-2">
                <button onclick="runScoring('${r.id}')" class="rounded-lg bg-accent-600 hover:bg-accent-700 text-white px-3 py-1.5 text-sm">Run AI Scoring</button>
                <button onclick="shortlistTop('${r.id}')" class="rounded-lg bg-emerald-600 hover:bg-emerald-700 text-white px-3 py-1.5 text-sm">Shortlist Top 3</button>
              </div>
            </div>
            <div class="mt-4 overflow-x-auto hide-scrollbar">
              <table class="min-w-full text-sm">
                <thead>
                  <tr class="text-left text-slate-600">
                    <th class="py-2 pr-4">Vendor</th>
                    <th class="py-2 pr-4">Amount</th>
                    <th class="py-2 pr-4">Relevance</th>
                    <th class="py-2 pr-4">Revenue</th>
                    <th class="py-2 pr-4">Profile</th>
                    <th class="py-2 pr-4">Score</th>
                    <th class="py-2 pr-4">Select</th>
                  </tr>
                </thead>
                <tbody class="align-top">
                  ${quotes.length ? quotes.map(q => {
                    const v = appState.vendors.find(x => x.id === q.vendorId);
                    const selectedClass = r.winnerVendorId === q.vendorId ? 'ring-2 ring-emerald-400' : '';
                    return `
                      <tr class="border-t border-slate-100 ${selectedClass}">
                        <td class="py-2 pr-4">
                          <div class="font-medium text-slate-900">${v?.name || q.vendorId}</div>
                          <div class="text-xs text-slate-500">finalized_items covered: ${q.finalized_itemsCovered || '—'}</div>
                        </td>
                        <td class="py-2 pr-4">${q.amount ? currency(q.amount) : '—'}</td>
                        <td class="py-2 pr-4">${q.scores ? q.scores.relevance + '%' : '—'}</td>
                        <td class="py-2 pr-4">${q.scores ? q.scores.revenue : '—'}</td>
                        <td class="py-2 pr-4">${q.scores ? q.scores.profile : '—'}</td>
                        <td class="py-2 pr-4 font-semibold">${q.scores ? q.scores.total : '—'}</td>
                        <td class="py-2 pr-4">
                          <button onclick="selectWinner('${r.id}','${q.vendorId}')" class="rounded-lg bg-white border border-slate-200 px-3 py-1.5 text-xs hover:bg-slate-50">Choose</button>
                        </td>
                      </tr>
                    `;
                  }).join('') : `
                    <tr><td colspan="7" class="text-center text-slate-500 py-8">Waiting for vendor quotes...</td></tr>
                  `}
                </tbody>
              </table>
            </div>
          </div>

          <div class="rounded-xl border border-slate-200 bg-white p-4">
            <div class="text-sm font-medium text-slate-900 mb-2">Shortlist</div>
            <div id="shortlist_${r.id}" class="grid sm:grid-cols-2 lg:grid-cols-3 gap-3">
              ${renderShortlist(r)}
            </div>
            <div class="mt-3">
              <button onclick="setAdminStep('Contract')" class="rounded-lg bg-slate-900 text-white px-3 py-1.5 text-sm">Proceed to Contract</button>
            </div>
          </div>

          <div class="rounded-xl border border-slate-200 bg-white p-4">
            <div class="text-sm font-medium text-slate-900 mb-2">Vendor Q&A</div>
            <div class="space-y-2">
              ${renderVendorQnA(r)}
            </div>
          </div>
        </div>
      `;
    }

    function renderShortlist(r) {
      const top = (r.quotes || []).filter(q => q.shortlisted);
      if (!top.length) return `<div class="text-sm text-slate-500 col-span-full">No shortlisted vendors yet.</div>`;
      return top.map(q => {
        const v = appState.vendors.find(x => x.id === q.vendorId);
        return `
          <div class="rounded-lg border border-slate-200 p-3">
            <div class="flex items-center justify-between">
              <div class="font-medium text-slate-900">${v?.name || q.vendorId}</div>
              <div class="flex items-center gap-1">${renderStars(v?.rating || 0)}</div>
            </div>
            <div class="text-xs text-slate-500">Overall ⭐ ${v?.rating ?? '—'}</div>
            ${v?.reviews?.length ? `<div class="text-xs text-slate-600 mt-1 line-clamp-2">"${lastFeedbackSnippet(v)}"</div>` : ''}
            <div class="text-xs text-slate-500 mb-1">${currency(q.amount)} · Score ${q.scores?.total ?? '—'}</div>
            <button onclick="selectWinner('${r.id}','${q.vendorId}')" class="rounded-lg bg-emerald-600 hover:bg-emerald-700 text-white px-3 py-1.5 text-xs">Select as Winner</button>
          </div>
        `;
      }).join('');
    }

    function renderVendorQnA(r) {
      const quotes = r.quotes || [];
      if (!quotes.length) return `<div class="text-xs text-slate-500">No Q&A yet.</div>`;
      const blocks = [];
      quotes.forEach(q => {
        const v = appState.vendors.find(x => x.id === q.vendorId);
        const answers = q.answers || {};
        const list = (r.questionnaires || []).map(question => `
          <div class="text-xs bg-slate-50 border border-slate-200 rounded-lg px-2 py-1">
            <div class="text-slate-700">${question}</div>
            <div class="text-slate-500 mt-0.5">${answers[question] ? answers[question] : '— No response yet'}</div>
          </div>
        `).join('');
        blocks.push(`
          <div class="rounded-xl border border-slate-200 p-3">
            <div class="font-medium text-slate-900 mb-1">${v?.name || q.vendorId}</div>
            <div class="space-y-1">${list}</div>
          </div>
        `);
      });
      return blocks.join('');
    }

    function renderAdminContract(r) {
      const winner = appState.vendors.find(v => v.id === r.winnerVendorId);
      const selectedQuote = (r.quotes || []).find(q => q.vendorId === r.winnerVendorId);
      return `
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
          <div class="lg:col-span-2 space-y-4">
            <div class="rounded-xl border border-slate-200 bg-white p-4">
              <div class="text-sm font-medium text-slate-900">Contract Offering</div>
              <form onsubmit="sendContract(event, '${r.id}')" class="space-y-3">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                  <div>
                    <label class="block text-xs text-slate-600 mb-1">Vendor</label>
                    <input type="text" value="${winner ? winner.name : ''}" disabled class="w-full rounded-lg border border-slate-200 bg-slate-50 px-3 py-2 text-sm">
                  </div>
                  <div>
                    <label class="block text-xs text-slate-600 mb-1">Contract Title</label>
                    <input id="c_title_${r.id}" type="text" value="${(r.title || 'Event Audio Services') + ' — Contract'}" class="w-full rounded-lg border border-slate-200 px-3 py-2 text-sm focus:ring-2 focus:ring-brand-400 outline-none">
                  </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                  <div>
                    <label class="block text-xs text-slate-600 mb-1">Start Date</label>
                    <input id="c_start_${r.id}" type="date" class="w-full rounded-lg border border-slate-200 px-3 py-2 text-sm focus:ring-2 focus:ring-brand-400 outline-none">
                  </div>
                  <div>
                    <label class="block text-xs text-slate-600 mb-1">Amount</label>
                    <input id="c_amount_${r.id}" type="number" value="${selectedQuote?.amount || ''}" placeholder="e.g. 5000" class="w-full rounded-lg border border-slate-200 px-3 py-2 text-sm focus:ring-2 focus:ring-brand-400 outline-none">
                  </div>
                  <div>
                    <label class="block text-xs text-slate-600 mb-1">Payment Terms</label>
                    <input id="c_terms_${r.id}" type="text" value="50% advance, 50% on delivery" class="w-full rounded-lg border border-slate-200 px-3 py-2 text-sm focus:ring-2 focus:ring-brand-400 outline-none">
                  </div>
                </div>
                <div>
                  <label class="block text-xs text-slate-600 mb-1">Scope</label>
                  <textarea id="c_scope_${r.id}" rows="4" class="w-full rounded-lg border border-slate-200 px-3 py-2 text-sm focus:ring-2 focus:ring-brand-400 outline-none" placeholder="Describe services...">${(r.finalized_items || []).map(i => `• ${i}`).join('\n')}</textarea>
                </div>
                <div class="flex items-center gap-2">
                  <button class="rounded-xl bg-pink-600 hover:bg-pink-700 text-white px-4 py-2.5">Send Contract</button>
                  <button type="button" onclick="previewContract('${r.id}')" class="rounded-xl bg-white border border-slate-200 px-4 py-2.5">Preview</button>
                  <button type="button" onclick="markServiceDelivered('${r.id}')" class="rounded-xl bg-emerald-600 hover:bg-emerald-700 text-white px-4 py-2.5">Mark Delivered</button>
                </div>
              </form>
            </div>
            <div id="contract_preview_${r.id}" class="hidden rounded-xl border border-slate-200 bg-white p-4">
              <div class="text-sm font-medium text-slate-900 mb-2">Contract Preview</div>
              <div class="prose-sm text-slate-800 whitespace-pre-wrap"></div>
            </div>
          </div>
          <div class="space-y-4">
            <div class="rounded-xl border border-slate-200 bg-white p-4">
              <div class="text-sm font-medium text-slate-900 mb-2">Selection</div>
              <div>${winner ? `${badge('Winner','emerald')} <span class="text-sm ml-1">${winner.name}</span>` : `<span class="text-sm text-slate-500">No vendor selected.</span>`}</div>
              <div class="mt-2">
                <button onclick="setAdminStep('Quotes')" class="rounded-lg bg-white border border-slate-200 px-3 py-1.5 text-sm hover:bg-slate-50">Change selection</button>
              </div>
            </div>
          </div>
        </div>
      `;
    }

    // ----------------------------
    // Vendor Role View
    // ----------------------------
function renderVendor() {
    if (!appState.vendor) appState.vendor = { activeVendorId: 1, invitations: [] };
    
    const vendorId = appState.vendor.activeVendorId;
    
    // FIX: Use appState.vendors if loaded, otherwise fall back to hardcoded allVendors
    const dropdownVendors = (appState.vendors && appState.vendors.length > 0) 
        ? appState.vendors 
        : (appState.vendor.allVendors || []);
    
    console.log("📋 Dropdown vendors being used:", dropdownVendors);
    
    const me = dropdownVendors.find(v => v.id === vendorId) || { name: "Unknown Vendor" };
    
    return `
        <section class="space-y-6">
            <div class="bg-white/80 backdrop-blur rounded-2xl border border-white shadow-soft p-5">
                <div class="flex items-center justify-between mb-3">
                    <div>
                        <div class="text-xs uppercase tracking-wider text-slate-500">Vendor Portal</div>
                        <div class="text-lg font-semibold text-slate-900">Welcome, ${me.name}</div>
                    </div>
                    <div class="flex items-center gap-2">
                        <label class="text-xs text-slate-600">Impersonate:</label>
                        <select 
                            onchange="switchVendor(this.value)" 
                            class="rounded-lg border border-slate-200 bg-white px-3 py-1.5 text-sm focus:ring-2 focus:ring-brand-400 outline-none"
                        >
                            ${dropdownVendors.length > 0 
                                ? dropdownVendors.map(v => 
                                    `<option value="${v.id}" ${v.id === vendorId ? 'selected' : ''}>${v.name}</option>`
                                  ).join('')
                                : '<option>No vendors available</option>'
                            }
                        </select>
                    </div>
                </div>
                <p class="text-sm text-slate-600">Submit quotes, answer questionnaires, and upload evidence.</p>
            </div>
            
            <div class="bg-white/80 backdrop-blur rounded-2xl border border-white shadow-soft p-5">
                <div class="flex items-center justify-between mb-3">
                    <h3 class="font-semibold text-slate-900">RFQ Invitations</h3>
                    <span class="text-xs text-slate-500">${appState.vendor.invitations.length} open</span>
                </div>
                <div class="space-y-3">
                    ${appState.vendor.invitations.length 
                        ? appState.vendor.invitations.map(r => renderVendorInvitation(r, vendorId)).join('')
                        : '<div class="text-center text-slate-500 py-8">No invitations yet.</div>'
                    }
                </div>
            </div>
        </section>
    `;
}

// Find this function in your index.html (around line 3084)
async function submitVendorQuote(event) {
  event.preventDefault();
  
  // Get the currently selected vendor's invitation data
  const currentVendor = vendors.find(v => v.vendor_id === currentVendorId);
  if (!currentVendor) {
    alert('No vendor selected');
    return;
  }
  
  // Fetch the RFQ invitation for this vendor
  const invitationsResponse = await fetch(
    `http://127.0.0.1:8000/rfqs/invitations/${currentVendorId}`
  );
  const invitations = await invitationsResponse.json();
  
  if (!invitations || invitations.length === 0) {
    alert('No RFQ invitation found for this vendor');
    return;
  }
  
  // Get the first (or active) invitation
  const invitation = invitations[0];
  const rfqId = invitation.rfq_id; // FIXED: Extract rfq_id properly
  
  // Get form data
  const amount = parseFloat(document.getElementById('quoteAmount').value);
  const itemsCovered = document.getElementById('quoteItems').value;
  
  if (!amount || !itemsCovered) {
    alert('Please fill in all quote fields');
    return;
  }
  
  // Submit the quote
  const response = await fetch('http://127.0.0.1:8000/quotes/submit', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      rfq_id: rfqId,  // FIXED: Use the extracted rfq_id
      vendor_id: currentVendorId,
      amount: amount,
      items_covered: itemsCovered
    })
  });
  
  if (response.ok) {
    alert('Quote submitted successfully!');
    // Refresh the vendor portal
    await loadVendorPortal(currentVendorId);
  } else {
    const error = await response.json();
    alert(`Failed to submit quote: ${error.detail}`);
  }
}

async function loadVendorPortal(vendorId) {
  currentVendorId = vendorId;
  
  // Fetch vendor details
  const vendorResponse = await fetch(`http://127.0.0.1:8000/vendors/${vendorId}`);
  const vendor = await vendorResponse.json();
  
  // Update welcome message
  document.getElementById('vendorWelcomeName').textContent = `Welcome, ${vendor.name}`;
  
  // Fetch RFQ invitations
  const invitationsResponse = await fetch(
    `http://127.0.0.1:8000/rfqs/invitations/${vendorId}`
  );
  const invitations = await invitationsResponse.json();
  
  console.log('RFQ Invitations:', invitations); // Debug log
  
  // Display invitations
  const invitationsContainer = document.getElementById('rfqInvitationsList');
  invitationsContainer.innerHTML = '';
  
  if (invitations && invitations.length > 0) {
    invitations.forEach(invitation => {
      const invitationCard = document.createElement('div');
      invitationCard.className = 'border rounded-lg p-4 cursor-pointer hover:bg-gray-50';
      invitationCard.innerHTML = `
        <h4 class="font-semibold">${invitation.requirement_title}</h4>
        <p class="text-sm text-gray-600">${invitation.requirement_query}</p>
        <span class="text-xs px-2 py-1 rounded ${invitation.status === 'Sent' ? 'bg-blue-100 text-blue-800' : 'bg-gray-100'}">
          ${invitation.status}
        </span>
      `;
      invitationCard.onclick = () => openRFQDetails(invitation);
      invitationsContainer.appendChild(invitationCard);
    });
  } else {
    invitationsContainer.innerHTML = '<p class="text-gray-500">No invitations yet.</p>';
  }
}

async function openRFQDetails(invitation) {
  // Store current invitation
  window.currentInvitation = invitation;
  
  // Parse questionnaire
  const questions = JSON.parse(invitation.rfq);
  
  // Populate the form
  document.getElementById('rfqRequirementTitle').textContent = invitation.requirement_title;
  
  // Display questions
  const questionnaireContainer = document.getElementById('rfqQuestionnaire');
  questionnaireContainer.innerHTML = '';
  
  questions.forEach((question, index) => {
    const questionDiv = document.createElement('div');
    questionDiv.className = 'mb-4';
    questionDiv.innerHTML = `
      <label class="block text-sm font-medium mb-2">
        ${index + 1}. ${question}
      </label>
      <textarea 
        id="answer_${index}"
        class="w-full border rounded-lg p-2"
        rows="3"
        placeholder="Your answer..."
      ></textarea>
    `;
    questionnaireContainer.appendChild(questionDiv);
  });
  
  // Show the RFQ details section
  document.getElementById('rfqDetailsSection').classList.remove('hidden');
}

async function submitVendorQuote(event) {
  event.preventDefault();
  
  if (!window.currentInvitation) {
    alert('No RFQ selected');
    return;
  }
  
  const invitation = window.currentInvitation;
  const amount = parseFloat(document.getElementById('quoteAmount').value);
  const itemsCovered = document.getElementById('quoteItems').value;
  
  if (!amount || !itemsCovered) {
    alert('Please fill in amount and items covered');
    return;
  }
  
  // Submit the quote
  const response = await fetch('http://127.0.0.1:8000/quotes/submit', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      rfq_id: invitation.rfq_id,  // Use rfq_id from invitation
      vendor_id: currentVendorId,
      amount: amount,
      items_covered: itemsCovered
    })
  });
  
  if (response.ok) {
    alert('Quote submitted successfully!');
    // Close details and refresh
    document.getElementById('rfqDetailsSection').classList.add('hidden');
    await loadVendorPortal(currentVendorId);
  } else {
    const error = await response.json();
    alert(`Failed to submit quote: ${error.detail}`);
  }
}


async function submitVendorAnswers(rfqId) {
    console.log("📝 Submitting answers for RFQ:", rfqId);
    
    // Get the invitation
    const invitation = appState.vendor.invitations.find(inv => inv.rfq_id === rfqId);
    if (!invitation) {
        console.error("Invitation not found for RFQ:", rfqId);
        return toast("Invitation not found", "error");
    }
    
    let questions = [];
    try {
        questions = typeof invitation.rfq === 'string' ? JSON.parse(invitation.rfq) : invitation.rfq;
    } catch (e) {
        return toast("Failed to parse questions", "error");
    }
    
    const answers = {};
    questions.forEach((q, idx) => {
        const answerEl = document.getElementById(`answer-${rfqId}-${idx}`);
        if (answerEl) {
            answers[q] = answerEl.value;
        }
    });
    
    console.log("Answers to submit:", answers);
    
    try {
        // FIXED: First submit a quote to get quote_id, then submit answers
        // Since backend expects quote_id, we need to get it from the database
        
        // Get all quotes for this requirement
        const quotesResponse = await apiCall(`/requirements/${invitation.req_id}/quotes`, "GET");
        
        // Find the quote for this vendor
        const vendorQuote = quotesResponse.find(q => 
            q.vendor_id === appState.vendor.activeVendorId && q.rfq_id === rfqId
        );
        
        if (!vendorQuote || !vendorQuote.quote_id) {
            return toast("Please submit a quote first before answering questions", "error");
        }
        
        // Now submit answers using quote_id (no leading slash)
        await apiCall(`/quotes/${vendorQuote.quote_id}/answers`, "PATCH", { 
            answers: answers 
        });
        
        toast("Answers submitted successfully!");
        await loadVendorInvitations(appState.vendor.activeVendorId);
    } catch (error) {
        console.error("Failed to submit answers:", error);
        toast("Failed to submit answers", "error");
    }
}



function renderVendorInvitation(invitation, vendorId) {
    // Parse the RFQ JSON string to get questions
    let questions = [];
    try {
        if (typeof invitation.rfq === 'string') {
            questions = JSON.parse(invitation.rfq);
        } else if (Array.isArray(invitation.rfq)) {
            questions = invitation.rfq;
        }
    } catch (e) {
        console.error("Failed to parse RFQ questions:", e);
        questions = [];
    }
    
    console.log("📋 Questionnaire for invitation:", invitation.rfqid, questions);
    
    return `
        <div class="rounded-xl border border-slate-200 bg-white p-4">
            <div class="flex items-center justify-between mb-2">
                <div class="font-medium text-slate-900">${invitation.requirementtitle || "Requirement"}</div>
                ${statusBadge(invitation.status)}
            </div>
            <div class="text-sm text-slate-600 mb-3">${invitation.requirementquery || "No description"}</div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <!-- Submit Quote Section -->
                <div class="rounded-lg border border-slate-200 p-3 space-y-3">
                    <div class="text-sm font-medium text-slate-900">Submit Quote</div>
                    
                    <div>
                        <label class="block text-xs text-slate-600 mb-1">Amount</label>
                        <input 
                            type="number" 
                            id="quote-amount-${invitation.rfqid}" 
                            placeholder="e.g. 5000" 
                            class="w-full rounded-lg border border-slate-200 px-3 py-2 text-sm"
                        />
                    </div>
                    
                    <div>
                        <label class="block text-xs text-slate-600 mb-1">Items covered</label>
                        <input 
                            type="text" 
                            id="quote-items-${invitation.rfqid}" 
                            placeholder="How many of the requested items?" 
                            class="w-full rounded-lg border border-slate-200 px-3 py-2 text-sm"
                        />
                    </div>
                    
                    <div>
                        <label class="block text-xs text-slate-600 mb-1">Upload evidence</label>
                        <input 
                            type="file" 
                            id="quote-files-${invitation.rfqid}" 
                            class="w-full text-sm"
                        />
                    </div>
                    
                    <button 
                        onclick="submitVendorQuote(${invitation.rfqid}, ${vendorId})" 
                        class="w-full rounded-lg bg-emerald-600 hover:bg-emerald-700 text-white px-4 py-2.5"
                    >
                        Submit Quote
                    </button>
                </div>
                
                <!-- Questionnaire Section -->
                <div class="rounded-lg border border-slate-200 p-3">
                    <div class="text-sm font-medium text-slate-900 mb-2">Questionnaire</div>
                    ${questions.length > 0 
                        ? `<div class="space-y-3">
                            ${questions.map((q, idx) => `
                                <div>
                                    <label class="block text-xs text-slate-600 mb-1">${idx + 1}. ${q}</label>
                                    <textarea 
                                        id="answer-${invitation.rfqid}-${idx}" 
                                        rows="2" 
                                        placeholder="Your answer..." 
                                        class="w-full rounded-lg border border-slate-200 px-2 py-1.5 text-sm"
                                    ></textarea>
                                </div>
                            `).join('')}
                            <button 
                                onclick="submitVendorAnswers(${invitation.rfqid})" 
                                class="w-full rounded-lg bg-brand-600 hover:bg-brand-700 text-white px-4 py-2.5"
                            >
                                Submit Answers
                            </button>
                           </div>`
                        : '<div class="text-sm text-slate-500">No questions for this RFQ</div>'
                    }
                </div>
            </div>
        </div>
    `;
}


    function hashKey(s) {
      return btoa(unescape(encodeURIComponent(s))).replace(/=+$/, '').slice(0, 10);
    }

    // ----------------------------
    // Actions (Admin)
    // ----------------------------
    function validateRequirement(id) {
      const r = appState.user.requests.find(x => x.id === id);
      if (!r) return;
      r.suggestions = aiSuggestfinalized_items(r.text);
      r.status = 'InReview';
      toast('Suggestions generated.');
      render();
    }

async function addItem(reqId, text) {
    try {
        const response = await apiCall(`/requirements/${reqId}/add-item`, 'POST', { item: text });
        
        console.log('✅ API Response:', response);
        console.log('✅ Response finalized_items:', response.finalized_items);
        
        // Update activeRequirement
        if (appState.admin.activeRequirement && appState.admin.activeRequirement.id === reqId) {
            appState.admin.activeRequirement.finalized_items = response.finalized_items || [];
            console.log('✅ Updated activeRequirement:', appState.admin.activeRequirement.finalized_items);
        }
        
        // Update in allRequests
        const reqInList = appState.admin.allRequests.find(x => x.id === reqId);
        if (reqInList) {
            reqInList.finalized_items = response.finalized_items || [];
        }
        
        render(); // Force re-render
        console.log('✅ Render called');
        
    } catch (error) {
        console.error('❌ Failed to add item:', error);
        toast('Failed to add item', 'error');
    }
}

async function removeItem(reqId, text) {
    console.log('🔴 removeItem called!');
    console.log('🔴 reqId:', reqId);
    console.log('🔴 text:', text);
    console.log('🔴 typeof reqId:', typeof reqId);
    console.log('🔴 typeof text:', typeof text);
    
    try {
        console.log('🔴 Calling API...');
        const response = await apiCall(`/requirements/${reqId}/remove-item`, 'POST', { item: text });
        console.log('🔴 API Response:', response);
        
        // Update frontend state
        if (appState.admin.activeRequirement && appState.admin.activeRequirement.id === reqId) {
            console.log('🔴 Updating activeRequirement...');
            appState.admin.activeRequirement.finalized_items = response.finalized_items || [];
            console.log('🔴 New finalized_items:', appState.admin.activeRequirement.finalized_items);
        }
        
        const reqInList = appState.admin.allRequests.find(x => x.id === reqId);
        if (reqInList) {
            console.log('🔴 Updating allRequests...');
            reqInList.finalized_items = response.finalized_items || [];
        }
        
        console.log('🔴 Calling render()...');
        render();
        console.log('🔴 removeItem complete!');
        
    } catch (error) {
        console.error('🔴 ERROR in removeItem:', error);
        toast('Failed to remove item', 'error');
    }
}







    function addCustomItem(id) {
      const input = document.getElementById(`add_${id}`);
      const value = (input.value || '').trim();
      if (!value) return;
      addItem(id, value);
      input.value = '';
    }

    function quickSelect(id, arr) {
      arr.forEach(v => addItem(id, v));
    }

async function sendToUserConfirmation(reqId) {
    try {
        appState.isLoading = true;
        render();
        
        const response = await apiCall(`/requirements/${reqId}/finalize`, 'POST');
        
        toast('✓ Sent to user for approval!');
        
        // Update state
        if (appState.admin.activeRequirement && appState.admin.activeRequirement.id === reqId) {
            appState.admin.activeRequirement.status = response.status;
        }
        
        appState.isLoading = false;
        render();
    } catch (error) {
        console.error('Failed to finalize:', error);
        toast('Failed to send to user', 'error');
        appState.isLoading = false;
        render();
    }
}


    function reuseTemplate(tid) {
      const t = appState.user.requests.find(x => x.id === tid);
      if (!t) return;
      const id = uid('req');
      appState.user.requests.push({
        id,
        createdAt: Date.now(),
        title: `${t.title} (Reused)`,
        text: t.text,
        files: [],
        finalized_items: [...(t.finalized_items || [])],
        suggestions: [],
        status: 'InReview',
        questionnaires: [...(t.questionnaires || [])],
        vendorsSelected: [],
        quotes: [],
        vendorSearchDone: false,
        filterTag: null
      });
      appState.admin.currentRequestId = id;
      appState.admin.currentStep = 'Validate';
      toast('Template reused into a new request.');
      render();
    }

    function createBlankRequest() {
      const id = uid('req');
      appState.user.requests.push({
        id,
        createdAt: Date.now(),
        title: 'Blank Request',
        text: 'Describe the requirement...',
        files: [],
        finalized_items: [],
        suggestions: [],
        status: 'Submitted',
        questionnaires: ['Confirm availability date', 'Warranty/Support details', 'Delivery/Setup time'],
        vendorsSelected: [],
        quotes: [],
        vendorSearchDone: false,
        filterTag: null
      });
      selectAdminRequest(id);
    }

    function jumpToQuotes() {
      appState.admin.currentStep = 'Quotes';
      render();
    }

    function searchVendors(rid) {
      const r = appState.user.requests.find(x => x.id === rid);
      if (!r) return;
      const tags = extractTagsFromRequest(r);
      const matches = appState.vendors.filter(v => tags.length ? v.tags.some(t => tags.includes(t)) : true);
      r.filteredVendors = matches;
      r.vendorSearchDone = true;
      r.filterTag = null;
      toast(`Found ${matches.length} vendor(s).`);
      render();
    }

    function filterVendors(rid, tag) {
      const r = appState.user.requests.find(x => x.id === rid);
      if (!r) return;
      r.filterTag = tag;
      render();
    }

    function clearVendorFilter(rid) {
      const r = appState.user.requests.find(x => x.id === rid);
      if (!r) return;
      r.filterTag = null;
      render();
    }

function toggleVendorSelect(reqId, vendorId, checked) {
    console.log('🔵 toggleVendorSelect called:', { reqId, vendorId, checked });
    
    const r = appState.admin.activeRequirement;
    
    // ✅ Convert reqId to number for comparison
    if (!r || r.id !== parseInt(reqId)) {
        console.error('❌ Active requirement mismatch!', { 
            activeId: r?.id, 
            receivedId: reqId, 
            parsedId: parseInt(reqId) 
        });
        return;
    }
    
    // Initialize if needed
    r.vendorsSelected = r.vendorsSelected || [];
    
    // Update selection
    const set = new Set(r.vendorsSelected);
    if (checked) {
        set.add(vendorId);
    } else {
        set.delete(vendorId);
    }
    r.vendorsSelected = Array.from(set);
    
    console.log('✅ Updated vendorsSelected:', r.vendorsSelected);
    
    // Re-render
    render();
}


async function sendRFQ(reqId) {
    console.log("sendRFQ called with reqId:", reqId);
    
    const r = appState.admin.activeRequirement;
    if (!r) {
        console.error("No active requirement found!");
        toast("No active requirement", "error");
        return;
    }
    
    if (r.id !== parseInt(reqId)) {
        console.error("Requirement ID mismatch!");
        toast("Active requirement mismatch", "error");
        return;
    }
    
    const selectedVendorIds = Array.from(r.vendorsSelected);
    console.log("Selected vendor IDs:", selectedVendorIds);
    
    if (selectedVendorIds.length === 0) {
        console.error("No vendors selected!");
        toast("Select vendors first.", "error");
        return;
    }
    
    try {
        appState.isLoading = true;
        render();
        
        // Set the mandatory 4 questions
        r.questionnaires = [
            "Can you provide us with a detailed company profile, including your founding date, ownership structure, and key leadership biographies?",
            "What is your financial standing? Are you profitable, and can you provide audited financial statements or credit reports for the last two years?",
            "What are your security protocols and data protection measures?",
            "What does your customer support model look like?"
        ];
        
        // Get vendor details from searchedVendors
        const selectedVendors = appState.admin.searchedVendors.filter(v => selectedVendorIds.includes(v.id));
        
        console.log("Sending RFQ...");
        console.log("- Requirement ID:", reqId);
        console.log("- Selected Vendors RAW:", selectedVendors);
        
        // Create vendor objects with ALL required fields for VendorRecord model
        const vendorPayload = selectedVendors.map(v => ({
            id: v.id || `vendor-${Date.now()}-${Math.random()}`,
            name: v.name || "Unknown Vendor",
            rating: parseFloat(v.rating) || 4.5,
            tags: Array.isArray(v.tags) ? v.tags : ["general"],
            revenue: v.revenue || 1000000,  // Add default revenue
            profile: v.profile || 75,        // Add default profile score
            reviews: v.reviews || []         // Add empty reviews array
        }));
        
        console.log("Vendor Payload COMPLETE:", vendorPayload);
        
        // Match backend's RFQRequest model
        const payload = { vendors: vendorPayload };
        
        console.log("Full API Payload:", JSON.stringify(payload, null, 2));
        
        const response = await apiCall(`/requirements/${reqId}/send-rfq`, "POST", payload);

        
        console.log("Backend response:", response);
        
        // Update status locally
        r.status = "RFQSent";
        r.quotes = r.quotes || [];
        
        // Initialize quote placeholders for each vendor
        selectedVendorIds.forEach(vid => {
            if (!r.quotes.find(q => q.vendorId === vid)) {
                r.quotes.push({
                    id: `quote-${Date.now()}-${vid}`,
                    vendorId: vid,
                    amount: null,
                    itemsCovered: null,
                    answers: {},
                    evidence: []
                });
            }
        });
        
        console.log("RFQ sent successfully!");
        toast(`RFQ sent to ${selectedVendors.length} vendors!`);
        
        appState.isLoading = false;
        render();
        
    } catch (error) {
        console.error("sendRFQ failed:", error);
        console.error("Error type:", typeof error);
        console.error("Error is Array:", Array.isArray(error));
        
        if (Array.isArray(error)) {
            console.error("Error array items:", error);
            error.forEach((err, idx) => {
                console.error(idx, err);
            });
        }
        
        if (error && typeof error === "object") {
            console.error("Error object keys:", Object.keys(error));
            console.error("Error stringified:", JSON.stringify(error, null, 2));
        }
        
        let errorMessage = "Failed to send RFQ";
        if (Array.isArray(error)) {
            errorMessage = error.map(e => JSON.stringify(e)).join(", ");
        } else if (error.message) {
            errorMessage = error.message;
        }
        
        toast(errorMessage, "error");
        appState.isLoading = false;
        render();
    }
}




    function sendQuestionnaire(rid) {
      const r = appState.user.requests.find(x => x.id === rid);
      if (!r || !(r.vendorsSelected || []).length) return toast('Select vendors first.');
      toast('Questionnaire sent to selected vendors.');
    }

    function runScoring(rid) {
      const r = appState.user.requests.find(x => x.id === rid);
      if (!r) return;
      computeQuoteScores(r);
      r.status = (r.quotes || []).some(q => q.amount) ? 'QuotesReceived' : r.status;
      toast('AI scoring complete.');
      render();
    }

    function shortlistTop(rid) {
      const r = appState.user.requests.find(x => x.id === rid);
      if (!r) return;
      computeQuoteScores(r);
      (r.quotes || []).forEach((q, i) => q.shortlisted = i < 3);
      r.status = 'Shortlisted';
      toast('Top 3 vendors shortlisted.');
      render();
    }

    function selectWinner(rid, vid) {
      const r = appState.user.requests.find(x => x.id === rid);
      if (!r) return;
      r.winnerVendorId = vid;
      toast('Winner selected. Proceed to contract.');
      render();
    }

    function previewContract(rid) {
      const title = document.getElementById(`c_title_${rid}`).value;
      const start = document.getElementById(`c_start_${rid}`).value || 'TBD';
      const amount = document.getElementById(`c_amount_${rid}`).value || 'TBD';
      const terms = document.getElementById(`c_terms_${rid}`).value;
      const scope = document.getElementById(`c_scope_${rid}`).value;

      const wrap = document.getElementById(`contract_preview_${rid}`);
      wrap.classList.remove('hidden');
      const body = wrap.querySelector('.prose-sm');
      body.textContent = `${title}\n\nStart: ${start}\nAmount: ${amount}\nTerms: ${terms}\n\nScope:\n${scope}`;
      toast('Contract preview updated.');
    }

    function sendContract(e, rid) {
      e.preventDefault();
      const r = appState.user.requests.find(x => x.id === rid);
      if (!r) return;
      if (!r.winnerVendorId) return toast('Select a winning vendor first.');
      r.status = 'ContractSent';
      toast('Contract sent to vendor (demo).');
      render();
    }

    function markServiceDelivered(rid) {
      const r = appState.requests.find(x => x.id === rid);
      if (!r) return;
      r.status = 'Closed';
      toast('Service marked as delivered. User can now provide feedback.');
      render();
    }

    // ----------------------------
    // Actions (Vendor)
    // ----------------------------
async function switchVendor(newVendorId) {
    console.log("🔄 Switching to vendor:", newVendorId);
    
    // Convert to number if it's a string
    const vendorId = parseInt(newVendorId);
    
    appState.vendor.activeVendorId = vendorId;
    appState.isLoading = true;
    render();
    
    try {
        // FIXED: Use correct endpoint path
        const invitations = await apiCall(`/rfqs/invitations/${vendorId}`, "GET");
        console.log("✅ Loaded invitations for vendor:", vendorId, invitations);
        appState.vendor.invitations = invitations;
    } catch (error) {
        console.error("❌ Failed to load invitations:", error);
        appState.vendor.invitations = [];
    }
    
    appState.isLoading = false;
    render();
}

async function loadVendorPortalData() {
    try {
        console.log("🔄 Loading vendor portal data...");
        
        // Fetch all vendors who have RFQs
        const response = await apiCall("/vendors/with-rfqs", "GET");
        console.log("✅ API Response:", response);
        
        // Store in appState.vendors
        if (Array.isArray(response) && response.length > 0) {
            appState.vendors = response.map(v => ({
                id: v.vendor_id,
                name: v.name,
                rating: v.rating || 4.5,
                tags: v.tags || []
            }));
            
            console.log("✅ Stored vendors:", appState.vendors);
            
            // IMPORTANT: Set first vendor as active (use actual vendor ID from DB)
            appState.vendor.activeVendorId = appState.vendors[0].id;
            console.log("✅ Set active vendor ID to:", appState.vendor.activeVendorId);
            
            // Load invitations for active vendor
            await loadVendorInvitations(appState.vendor.activeVendorId);
        } else {
            console.warn("⚠️ No vendors returned from API, using hardcoded vendors");
        }
        
    } catch (error) {
        console.error("❌ Failed to load vendor portal data:", error);
    }
}



async function loadVendorInvitations(vendorId) {
    try {
        const invitations = await apiCall(`/rfqs/invitations/${vendorId}`, "GET");
        console.log("Invitations for vendor", vendorId, ":", invitations);
        appState.vendor.invitations = invitations;
        render();
    } catch (error) {
        console.error("Failed to load invitations:", error);
        appState.vendor.invitations = [];
    }
}


    function submitQuote(e, rid, vid) {
      e.preventDefault();
      const amount = parseFloat(document.getElementById(`q_amount_${rid}_${vid}`).value || '0');
      const finalized_items = parseInt(document.getElementById(`q_finalized_items_${rid}_${vid}`).value || '0');
      const files = Array.from(document.getElementById(`q_files_${rid}_${vid}`).files || []).map(f => ({
        name: f.name,
        size: f.size
      }));
      const r = appState.user.requests.find(x => x.id === rid);
      if (!r) return;
      const q = (r.quotes || []).find(x => x.vendorId === vid);
      if (!q) return;
      q.amount = isNaN(amount) ? null : amount;
      q.finalized_itemsCovered = isNaN(finalized_items) ? null : finalized_items;
      q.evidence = files;
      q.submittedAt = Date.now();
      toast('Quote submitted.');
      render();
    }

    function submitAnswers(rid, vid) {
      const r = appState.user.requests.find(x => x.id === rid);
      if (!r) return;
      const q = (r.quotes || []).find(x => x.vendorId === vid);
      if (!q) return;
      const answers = {};
      (r.questionnaires || []).forEach(question => {
        const el = document.getElementById(`ans_${r.id}_${vid}_${hashKey(question)}`);
        if (el) answers[question] = el.value;
      });
      q.answers = answers;
      toast('Answers submitted.');
      render();
    }

    // ----------------------------
    // Feedback Modal Logic
    // ----------------------------
    function openFeedback(requestId) {
      appState.feedbackDraft = {
        requestId,
        rating: 0
      };
      document.getElementById('feedbackComment').value = '';
      const modal = document.getElementById('feedbackModal');
      modal.classList.remove('hidden');
      setupStarButtons();
    }

    function closeFeedback() {
      document.getElementById('feedbackModal').classList.add('hidden');
    }

    function setupStarButtons() {
      const stars = document.querySelectorAll('.star-btn');
      stars.forEach(btn => {
        btn.classList.remove('text-amber-500');
        btn.textContent = '☆';
        btn.onclick = () => {
          d
          const val = parseInt(btn.getAttribute('data-star'));
          appState.feedbackDraft.rating = val;
          stars.forEach(s => {
            const sVal = parseInt(s.getAttribute('data-star'));
            if (sVal <= val) {
              s.textContent = '★';
              s.classList.add('text-amber-500');
            } else {
              s.textContent = '☆';
              s.classList.remove('text-amber-500');
            }
          });
        };
      });
    }

    function submitFeedback(e) {
      e.preventDefault();
      const {
        requestId,
        rating
      } = appState.feedbackDraft || {};
      if (!requestId || !rating) {
        toast('Please select a rating.');
        return;
      }
      const comment = document.getElementById('feedbackComment').value.trim();
      const r = appState.user.requests.find(x => x.id === requestId);
      if (!r) return;
      r.feedback = {
        rating,
        comment,
        date: Date.now()
      };

      // Update vendor aggregate rating
      if (r.winnerVendorId) {
        const v = appState.vendors.find(v => v.id === r.winnerVendorId);
        if (v) {
          v.reviews = v.reviews || [];
          v.reviews.push({
            rating,
            comment,
            requestId
          });
          recomputeVendorRating(v);
        }
      }

      closeFeedback();
      toast('Thanks for your feedback!');
      render();
    }

    // ----------------------------
    // Role Tabs + Rendering
    // ----------------------------
    function renderRoleTabs() {
      const tabsContainer = document.getElementById('roleTabs');
      const roles = ['User', 'Admin', 'Vendor'];
      tabsContainer.innerHTML = roles.map(r =>
        `<button onclick="setRole('${r}')" class="px-3 py-1.5 rounded-full text-sm font-medium border transition ${appState.role === r ? 'bg-slate-900 text-white border-slate-900' : 'bg-white text-slate-700 border-slate-200 hover:bg-slate-50'}">${r}</button>`
      ).join('');
    }

    function render() {
      const container = document.getElementById('app'); // Use your main content div ID
      renderRoleTabs();
      if (appState.isLoading) {
        container.innerHTML = `<div class="text-center p-10">Loading...</div>`;
        return;
      }
      switch (appState.role) {
        case 'User':
          container.innerHTML = renderUser();
          break;
        case 'Admin':
          container.innerHTML = appState.admin.activeRequirement ? renderAdminRequestDetail() : renderAdminDashboard();
          break;
        case 'Vendor':
          container.innerHTML = renderVendor();
          break;
        default:
          container.innerHTML = '<div>Select a role to begin.</div>';
      }
      const chatMessages = document.getElementById('chat-messages');
      if (chatMessages) chatMessages.scrollTop = chatMessages.scrollHeight;
    }
    // ----------------------------
    // Simple toast
    // ----------------------------
    let toastTimer = null;

    function toast(message, type = 'success') {
      let el = document.getElementById('toast');
      if (!el) {
        el = document.createElement('div');
        el.id = 'toast';
        el.className = 'fixed bottom-5 left-1/2 -translate-x-1/2 z-[999]';
        document.body.appendChild(el);
      }
      const bgColor = type === 'error' ? 'bg-red-600' : 'bg-slate-900';
      el.innerHTML = `<div class="rounded-full ${bgColor} text-white px-4 py-2 text-sm shadow-lg border border-white/10">${message}</div>`;
      clearTimeout(toastTimer);
      toastTimer = setTimeout(() => {
        el.innerHTML = ''
      }, 3000);
    }
    // ----------------------------
    // Init
    // ----------------------------
    render();
    // CHATBOT
    function toggleChat(open) {
      const panel = document.getElementById('chatPanel');
      panel.classList.toggle('chat-open', open);
      panel.classList.toggle('chat-closed', !open);
    }

    function handleChat() {
      const input = document.getElementById('chatInput');
      const text = input.value.trim();
      if (!text) return;
      addChat('user', text);
      input.value = '';
      setTimeout(() => {
        respondChat(text);
      }, 400);
    }

    function addChat(role, text, html = false) {
      const body = document.getElementById('chatBody');
      const bubble = document.createElement('div');
      bubble.className = `max-w-[90%] ${role==='user'?'ml-auto':''}`;
      bubble.innerHTML = `
        <div class="inline-block px-3 py-2 rounded-lg ${role==='user'?'bg-primary-600 text-white':'bg-steel-100 dark:bg-steel-700'} text-sm">${html? text : escapeHtml(text)}</div>
      `;
      body.appendChild(bubble);
      body.scrollTop = body.scrollHeight;
    }

    function respondChat(q) {
      const lower = q.toLowerCase();
      if (lower.includes('top') && lower.includes('violation')) {
        const data = [{
          name: '3-way match missing',
          count: 42
        }, {
          name: 'Round-dollar > $50k',
          count: 31
        }, {
          name: 'Skipped approval',
          count: 27
        }, {
          name: 'Duplicate vendor',
          count: 19
        }, {
          name: 'SoD conflict',
          count: 15
        }, ];
        const bars = data.map(d => `
          <div class="flex items-center gap-2">
            <div class="w-40 text-xs">${d.name}</div>
            <div class="flex-1 h-2 bg-steel-200 dark:bg-steel-700 rounded">
              <div class="h-2 bg-primary-600 rounded" style="width:${Math.min(100, d.count)}%"></div>
            </div>
            <div class="w-8 text-right text-xs">${d.count}</div>
          </div>
        `).join('');
        addChat('bot', `
          <div class="space-y-2">
            <div class="font-semibold">Top 5 compliance violations — Q2</div>
            ${bars}
            <div class="text-xs text-steel-500">Source: Finance Auditor & Process Miner</div>
          </div>
        `, true);
      } else if (lower.includes('esg') || lower.includes('environment')) {
        addChat('bot', `
          <div>
            ESG risk index currently at <span class="font-semibold">0.32</span> (Low). Main drivers: supplier disclosure lag and emission factor updates.
          </div>
        `, true);
      } else {
        addChat('bot', `
          <div>Here’s a summary I can help with: run an instant audit, explain a finding, or generate a report preview. Try asking: “Explain TX-1003” or “Generate remediation summary”.</div>
        `, true);
      }
    }

    function escapeHtml(s) {
      return s.replace(/[&<>"']/g, m => ({
        '&': '&amp;',
        '<': '&lt;',
        '>': '&gt;',
        '"': '&quot;',
        "'": '&#039;'
      } [m]));
    }

    // MODAL
    function openModal(title, bodyHtml, footerHtml) {
      document.getElementById('modalTitle').innerHTML = title;
      document.getElementById('modalBody').innerHTML = bodyHtml;
      document.getElementById('modalFooter').innerHTML = footerHtml || '';
      document.getElementById('modal').classList.remove('hidden');
    }

    function closeModal() {
      document.getElementById('modal').classList.add('hidden');
    }

    // Toast (simple)
    function toast(msg) {
      const t = document.createElement('div');
      t.className = 'fixed bottom-6 left-1/2 -translate-x-1/2 z-[60] px-4 py-2 rounded-lg bg-steel-900 text-white shadow-card';
      t.textContent = msg;
      document.body.appendChild(t);
      setTimeout(() => t.remove(), 1800);
    }

    function toast(message, type = 'success') {
      let el = document.getElementById('toast');
      if (!el) {
        el = document.createElement('div');
        el.id = 'toast';
        el.className = 'fixed bottom-5 left-1/2 -translate-x-1/2 z-[999]';
        document.body.appendChild(el);
      }
      const bgColor = type === 'error' ? 'bg-red-600' : 'bg-slate-900';
      el.innerHTML = `<div class="rounded-full ${bgColor} text-white px-4 py-2 text-sm shadow-lg border border-white/10">${message}</div>`;
      clearTimeout(toastTimer);
      toastTimer = setTimeout(() => {
        el.innerHTML = ''
      }, 3000);
    }

    // Quick actions
    function runAuditFlow() {
      openModal('Instant Audit', `
        <div class="space-y-3">
          <div class="text-sm text-steel-600 dark:text-steel-300">Running AI checks across Finance, IT, and Compliance...</div>
          <div class="h-2 rounded-full bg-steel-100 dark:bg-steel-700 overflow-hidden">
            <div id="auditBar" class="h-2 bg-primary-600 rounded" style="width:0%"></div>
          </div>
          <div id="auditStatus" class="text-sm">Starting...</div>
        </div>
      `);
      let pct = 0;
      const step = () => {
        pct += Math.random() * 22;
        if (pct >= 100) {
          pct = 100;
          document.getElementById('auditBar').style.width = pct + '%';
          document.getElementById('auditStatus').textContent = 'Completed. 12 findings detected (3 critical).';
          document.getElementById('modalFooter').innerHTML = `
            <button class="px-4 py-2.5 rounded-lg border border-steel-200 dark:border-steel-700" onclick="closeModal()">Close</button>
            <button class="px-4 py-2.5 rounded-lg bg-primary-600 text-white" onclick="navigate('explore'); closeModal()">View findings</button>
          `;
        } else {
          document.getElementById('auditBar').style.width = pct + '%';
          document.getElementById('auditStatus').textContent = pct < 40 ? 'Analyzing transactions...' : pct < 75 ? 'Mining processes...' : 'Cross-checking compliance...';
          setTimeout(step, 500);
        }
      };
      setTimeout(step, 500);
    }

    function openReportWizard() {
      openModal('Generate Report', `
        <form id="reportForm" class="space-y-3" onsubmit="event.preventDefault(); generateReport();">
          <label class="block">
            <div class="text-sm mb-1">Audience</div>
            <select id="repAudience" class="w-full px-3 py-2 rounded-lg border border-steel-200 dark:border-steel-700 bg-white dark:bg-steel-900">
              <option>Executive</option><option>Audit Committee</option><option>Operational</option>
            </select>
          </label>
          <label class="block">
            <div class="text-sm mb-1">Scope</div>
            <select id="repScope" class="w-full px-3 py-2 rounded-lg border border-steel-200 dark:border-steel-700 bg-white dark:bg-steel-900">
              <option>Quarter-to-date</option><option>Month-to-date</option><option>Custom</option>
            </select>
          </label>
          <label class="block">
            <div class="text-sm mb-1">Include</div>
            <div class="grid grid-cols-2 gap-2 text-sm">
              ${['Findings','Heatmaps','Compliance','Remediation','ESG'].map(x=>`
                <label class="inline-flex items-center gap-2 p-2 rounded-lg border border-steel-200 dark:border-steel-700">
                  <input type="checkbox" class="accent-primary-600" checked> ${x}
                </label>
              `).join('')}
            </div>
          </label>
          <button class="px-4 py-2.5 rounded-lg bg-primary-600 text-white">Generate</button>
        </form>
      `, `<button class="px-4 py-2.5 rounded-lg border border-steel-200 dark:border-steel-700" onclick="closeModal()">Cancel</button>`);
    }

    function generateReport() {
      document.getElementById('modalBody').innerHTML = `
        <div class="space-y-3">
          <div class="text-sm">Compiling report...</div>
          <div class="h-2 rounded-full bg-steel-100 dark:bg-steel-700 overflow-hidden">
            <div class="h-2 bg-primary-600 rounded w-2/3 animate-pulse"></div>
          </div>
        </div>
      `;
      document.getElementById('modalFooter').innerHTML = '';
      setTimeout(() => {
        document.getElementById('modalBody').innerHTML = `
          <div class="space-y-3">
            <div class="text-sm">Report ready (Demo). You can preview or download a sample.</div>
          </div>
        `;
        document.getElementById('modalFooter').innerHTML = `
          <button class="px-4 py-2.5 rounded-lg bg-primary-600 text-white" onclick="previewReport('Executive Summary',3)">Preview</button>
          <button class="px-4 py-2.5 rounded-lg border border-steel-200 dark:border-steel-700" onclick="downloadSample('Executive Summary')">Download sample</button>
        `;
      }, 1200);
    }
    async function loadVendorInvitations(vendorId) {
    try {
        console.log('📥 Loading invitations for vendor:', vendorId);
        
        const invitations = await apiCall(`/rfqs/invitations/${vendorId}`, 'GET');
        
        console.log('📥 Received invitations:', invitations);
        
        appState.vendor.invitations = invitations || [];
        render();
    } catch (error) {
        console.error('❌ Failed to load vendor invitations:', error);
        appState.vendor.invitations = [];
    }
}

    // PROCESS LAYERS
    function toggleProcessLayers() {
      const a = document.getElementById('toggleAsIs').checked;
      const d = document.getElementById('toggleAsDesigned').checked;
      document.getElementById('flowAsIs').style.display = a ? 'block' : 'none';
      document.getElementById('flowDesigned').style.display = d ? 'block' : 'none';
    }

    // Alerts dropdown click-away
    document.addEventListener('click', (e) => {
      const m = document.getElementById('notifMenu');
      const b = document.getElementById('bellBtn');
      if (!m.contains(e.target) && !b.contains(e.target)) m.classList.add('hidden');
    });

    // Build remaining sections on nav load
    function renderReportsOnce() {
      renderRemediation();
    }
    renderReportsOnce();

    // Page renders
    function renderAlertsOnce() {
      renderAlerts();
    }
    renderAlertsOnce();

    // Helpers: icons
    function iconGrid() {
      return `<svg class="h-4 w-4" viewBox="0 0 24 24" fill="currentColor"><path d="M3 3h8v8H3V3Zm10 0h8v8h-8V3ZM3 13h8v8H3v-8Zm10 0h8v8h-8v-8Z"/></svg>`;
    }

    function iconBots() {
      return `<svg class="h-4 w-4" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2a1 1 0 0 1 1 1v1h4a2 2 0 0 1 2 2v6a4 4 0 0 1-4 4h-2v3h3v2H8v-2h3v-3H9a4 4 0 0 1-4-4V6a2 2 0 0 1 2-2h4V3a1 1 0 0 1 1-1Z"/></svg>`; 
    }

    function iconSearch(){ return `<svg class="h-4 w-4" viewBox="0 0 24 24" fill="currentColor"><path d="M11 4a7 7 0 1 1 0 14 7 7 0 0 1 0-14Zm6.32 12.9 3.39 3.39-1.42 1.42-3.39-3.39"/></svg>`; }

    function iconShield(){ return `<svg class="h-4 w-4" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2 4 5v6c0 5 3.4 9.7 8 11 4.6-1.3 8-6 8-11V5l-8-3Z"/></svg>`; }

     function iconDoc(){ return `<svg class="h-4 w-4" viewBox="0 0 24 24" fill="currentColor"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12V8l-4-6Z"/></svg>`; }

    function iconBell(){ return `<svg class="h-4 w-4" viewBox="0 0 24 24" fill="currentColor"><path d="M12 22a2 2 0 0 0 2-2h-4a2 2 0 0 0 2 2Zm6-6V11a6 6 0 0 0-12 0v5l-2 2v1h16v-1l-2-2Z"/></svg>`; }

    function iconUsers(){

     return `<svg class="h-4 w-4" viewBox="0 0 24 24" fill="currentColor">

        <path d="M16 11c1.66 0 3-1.34 3-3s-1.34-3-3-3-3

        1.34-3 3 1.34 3 3 3Zm-8 0c1.66 0 3-1.34

        3-3S9.66 5 8 5 5 6.34 5 8s1.34 3 3

        3Zm0 2c-2.67 0-8 1.34-8 4v2h10v-2c0-2.66-5.33-4-8-4Zm8

        0c-.29 0-.62.02-.97.05A5.978 5.978 0 0 1 20

        17v2h4v-2c0-2.66-5.33-4-8-4Z"/>

        </svg>`;

    }



 </script>


</html>